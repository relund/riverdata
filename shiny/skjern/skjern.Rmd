---
title: "Dashboard for Skjern Å"
author: ''
output:
  flexdashboard::flex_dashboard:
    css: style.css
    favicon: favicon.png
    orientation: rows
    theme: paper
    vertical_layout: fill
resource_files:
- www/boy.gif
- www/c_and_r.gif
- www/cut.gif
- www/foto.gif
- www/girl.gif
- www/info.png
- www/net.gif
runtime: shiny
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
#profvis({rmarkdown::run("karup.Rmd", shiny_args = list(host="0.0.0.0", port=5050))})
library(knitr)
library(ggplot2)
# library(plotly)
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(shiny)
library(DT)
# library(formattable)
library(flextable)
library(shinyBS)
library(kableExtra)
# library(zoo) 
```

```{r global, include=FALSE}  
faIcon <- function (name, class = "", title = "", lib = "font-awesome") 
{
    prefixes <- list(`font-awesome` = "fa", glyphicon = "glyphicon")
    prefix <- prefixes[[lib]]
    if (is.null(prefix)) {
        stop("Unknown font library '", lib, "' specified. Must be one of ", 
            paste0("\"", names(prefixes), "\"", collapse = ", "))
    }
    if (class != "") class = paste0(" ", class)
    prefix_class <- prefix
    if (prefix_class == "fa" && name %in% shiny:::font_awesome_brands) {
        prefix_class <- "fab"
    } else if (prefix_class == "fa") prefix_class <- "fas"
    iconClass <- paste0(prefix_class, " ", prefix, "-", name, class)
    iconTag <- tags$i(class = iconClass, title = title)
    htmltools::htmlDependencies(iconTag) <- htmltools::htmlDependency("font-awesome", 
        "5.3.1", "www/shared/fontawesome", package = "shiny", 
        stylesheet = c("css/all.min.css", "css/v4-shims.min.css"))
    htmltools::browsable(iconTag)
}


# load data in 'global' chunk so it can be shared by all users of the dashboard
addResourcePath('www', paste0(getwd(), "/www"))
prefix <- "https://raw.githubusercontent.com/relund/skjern/master/data/"


#### Weight - Estimates ####
datWeightTrout <- read_csv(paste0(prefix, "data_skjern_weight_seatrout.csv"))
datWeightSalmon <- read_csv(paste0(prefix, "data_skjern_weight_salmon.csv"))


#### Catch - Records ####
datCatchSalmon <- read_csv(paste0(prefix, "data_skjern_catch_salmon.csv")) %>% 
  mutate(
    Misc = paste0(
      if_else(!Killed, "<img src=\"www/c_and_r.gif\" alt=\"C&R\">", "", ""),
      if_else(Cut, "<img src=\"www/cut.gif\" alt=\"Finneklippet\">", "", "")
    ),
    Month = month(Date, label = T), Week = week(Date), Year = year(Date), 
    NoWeight = 1*is.na(Weight), Day = yday(Date), DayStr = format(Date, "%d. %b")
  )
datCatchSalmon <- left_join(datCatchSalmon, datWeightSalmon, by = c("Length", "Month" = "Period")) %>% 
  mutate(Weight = if_else(is.na(Weight), round(Avg,1), Weight)) %>% 
  mutate(Fulton = Weight*100000/Length^3) %>% 
  mutate(Month = month(Date, label = T), 
         Place = case_when(
        str_detect(Place, "Øvre|Rind|Karstoft|Vinbæk") ~ "Øvre",
        str_detect(Place, "Mellem|Tarp|Felding|Konsortiet") ~ "Mellem",
        str_detect(Place, "Nedre|A11|Albæk|Borris") ~ "Nedre",
        str_detect(Place, "Vorgod") ~ "Vorgod Å",
        str_detect(Place, "Omme") ~ "Omme Å",
        TRUE ~ "Andet"
      ))


datCatchTrout <- read_csv(paste0(prefix, "data_skjern_catch_seatrout.csv")) %>% 
  mutate(
    Misc = paste0(
      if_else(!Killed, "<img src=\"www/c_and_r.gif\" alt=\"C&R\">", "", ""),
      if_else(Cut, "<img src=\"www/cut.gif\" alt=\"Finneklippet\">", "", "")
    ),
    Month = month(Date, label = T), Week = week(Date), Year = year(Date), NoWeight = 1*is.na(Weight), Day = yday(Date)
  )
datCatchTrout <- left_join(datCatchTrout, datWeightTrout, by = c("Length", "Month" = "Period")) %>% 
  mutate(Weight = if_else(is.na(Weight), round(Avg,1), Weight)) %>% 
  mutate(Fulton = Weight*100000/Length^3) %>% 
  mutate(Month = month(Date, label = T), Place = case_when(
        str_detect(Place, "Øvre|Rind|Karstoft|Vinbæk") ~ "Øvre",
        str_detect(Place, "Mellem|Tarp|Felding|Konsortiet") ~ "Mellem",
        str_detect(Place, "Nedre|A11|Albæk|Borris") ~ "Nedre",
        str_detect(Place, "Vorgod") ~ "Vorgod Å",
        str_detect(Place, "Omme") ~ "Omme Å",
        TRUE ~ "Andet"
      ))


#### Catch - Yearly statistics ####
datStatYearSalmon <- datCatchSalmon %>% 
  mutate(Year = year(Date)) %>% group_by(Year) %>% nest() %>% 
  mutate(
    TotalStat = map(data, function(df) {
      summarise(df, Total = n(), 
                Released = sum(!Killed, na.rm = T),
                Killed = sum(Killed, na.rm = T),
                KilledUnknown = Total - Released - Killed,
                LengthAvg = mean(Length, na.rm = T), 
                LengthMax = max(Length, na.rm = T),
                WeightAvg = mean(Weight, na.rm = T), 
                WeightMax = max(Weight, na.rm = T),
                Kg = sum(Weight, na.rm = T),
                FultonAvg = mean(Fulton, na.rm = T), 
                FultonMax = max(Fulton, na.rm = T)
      )
    }),
    PlaceStat = 
      map(data, 
          function(df) {
            df %>% 
              group_by(Place) %>% 
              summarize(TotalP = n(), 
                        KilledP = sum(Killed))}),
    MethodStat = 
      map(data, 
          function(df) {
            df %>% 
              group_by(Method) %>% 
              summarize(TotalM = n())}),
  )

datStatYearSalmon <- datStatYearSalmon %>% 
  mutate(PlaceStat = 
           map(PlaceStat, function(df) {  
             pivot_wider(df, names_from = Place, values_from = c(TotalP, KilledP))}),
         MethodStat = 
           map(MethodStat, function(df) {  
             pivot_wider(df, names_from = Method, values_from = c(TotalM))}),
         ) %>% 
  unnest(cols = c(TotalStat, PlaceStat, MethodStat)) %>% select(-data) %>% 
  replace(., is.na(.), 0)


datStatYearSalmon <- 
  datStatYearSalmon  %>% 
  ungroup() %>% 
  transmute(Year, Total, 
     # Sex = paste0(format(100*Male/Total, digits = 0, trim = TRUE), "/", 
     #              format(100*Female/Total, digits = 0, trim = TRUE), "/", 
     #              format(100*SexUnknown/Total, digits = 0, trim = TRUE)), 
     Place = paste0(format(100*TotalP_Nedre/Total, digits = 0, trim = TRUE), "/", 
                    format(100*TotalP_Mellem/Total, digits = 0, trim = TRUE), "/", 
                    format(100*`TotalP_Øvre`/Total, digits = 0, trim = TRUE), "/", 
                    format(100*`TotalP_Vorgod Å`/Total, digits = 0, trim = TRUE), "/",
                    format(100*`TotalP_Omme Å`/Total, digits = 0, trim = TRUE), "/",
                    format(100*`TotalP_Andet`/Total, digits = 0, trim = TRUE)),
     PlaceK = paste0(format(100*KilledP_Nedre/Killed, digits = 0, trim = TRUE), "/", 
                    format(100*KilledP_Mellem/Killed, digits = 0, trim = TRUE), "/", 
                    format(100*`KilledP_Øvre`/Killed, digits = 0, trim = TRUE), "/", 
                    format(100*`KilledP_Vorgod Å`/Killed, digits = 0, trim = TRUE), "/",
                    format(100*`KilledP_Omme Å`/Killed, digits = 0, trim = TRUE), "/",
                    format(100*`KilledP_Andet`/Killed, digits = 0, trim = TRUE)),
     Method = paste0(format(100*Flue/Total, digits = 0, trim = TRUE), "/", 
                    format(100*Spin/Total, digits = 0, trim = TRUE), "/", 
                    format(100*Orm/Total, digits = 0, trim = TRUE), "/", 
                    format(100*Andet/Total, digits = 0, trim = TRUE)),
     Released = paste0(round(100*Released/Total, 0), "/", 
                       round(100*Killed/Total, 0)),
     Length = paste0(round(LengthAvg,0), "/", round(LengthMax,0)), 
     Weight = paste0(round(WeightAvg,1), "/", round(WeightMax,1), "/", round(Kg,0)), 
     Fulton = paste0(round(FultonAvg,2), "/", round(FultonMax,2))) %>%
  mutate_if(is.character, str_replace_all, pattern = "NaN|NA", replacement = "0")



#### Catch - Monthly statistics ####
datStatMonthSalmon <- datCatchSalmon %>% 
  dplyr::filter(year(Date) == year(now())) %>% 
  group_by(Month) %>% nest() %>% 
  mutate(
    TotalStat = map(data, function(df) {
      summarise(df, Total = n(), 
                Released = sum(!Killed, na.rm = T),
                Killed = sum(Killed, na.rm = T),
                KilledUnknown = Total - Released - Killed,
                LengthAvg = mean(Length, na.rm = T), 
                LengthMax = max(Length, na.rm = T),
                WeightAvg = mean(Weight, na.rm = T), 
                WeightMax = max(Weight, na.rm = T),
                Kg = sum(Weight, na.rm = T),
                FultonAvg = mean(Fulton, na.rm = T), 
                FultonMax = max(Fulton, na.rm = T)
      )
    }),
    PlaceStat = 
      map(data, 
          function(df) {
            df %>% 
              group_by(Place) %>% 
              summarize(TotalP = n(), 
                        KilledP = sum(Killed))}),
    MethodStat = 
      map(data, 
          function(df) {
            df %>% 
              group_by(Method) %>% 
              summarize(TotalM = n())}),
  )

datStatMonthSalmon <- datStatMonthSalmon %>% 
  mutate(PlaceStat = 
           map(PlaceStat, function(df) {  
             pivot_wider(df, names_from = Place, values_from = c(TotalP, KilledP))}),
         MethodStat = 
           map(MethodStat, function(df) {  
             pivot_wider(df, names_from = Method, values_from = c(TotalM))}),
         ) %>% 
  unnest(cols = c(TotalStat, PlaceStat, MethodStat)) %>% select(-data) %>% 
  replace(., is.na(.), 0)
 
if (nrow(datStatMonthSalmon) == 0) {
  datStatMonthSalmon <- datStatYearSalmon %>% slice(0)
  colnames(datStatMonthSalmon)[1] <- "Month"
}   

datStatMonthSalmon <- 
  datStatMonthSalmon %>% 
  ungroup() %>% 
  transmute(Month, Total, 
     # Sex = paste0(format(100*Male/Total, digits = 0, trim = TRUE), "/", 
     #              format(100*Female/Total, digits = 0, trim = TRUE), "/", 
     #              format(100*SexUnknown/Total, digits = 0, trim = TRUE)), 
     Place = paste0(format(100*TotalP_Nedre/Total, digits = 0, trim = TRUE), "/", 
                    format(100*TotalP_Mellem/Total, digits = 0, trim = TRUE), "/", 
                    format(100*`TotalP_Øvre`/Total, digits = 0, trim = TRUE), "/", 
                    format(100*`TotalP_Vorgod Å`/Total, digits = 0, trim = TRUE), "/",
                    format(100*`TotalP_Omme Å`/Total, digits = 0, trim = TRUE), "/",
                    {if ("TotalP_Andet" %in% names(.)) format(100*`TotalP_Andet`/Total, digits = 0, trim = TRUE) else "0"}),
     PlaceK = paste0(format(100*KilledP_Nedre/Killed, digits = 0, trim = TRUE), "/", 
                    format(100*KilledP_Mellem/Killed, digits = 0, trim = TRUE), "/", 
                    format(100*`KilledP_Øvre`/Killed, digits = 0, trim = TRUE), "/", 
                    format(100*`KilledP_Vorgod Å`/Killed, digits = 0, trim = TRUE), "/",
                    format(100*`KilledP_Omme Å`/Killed, digits = 0, trim = TRUE), "/",
                    {if ("KilledP_Andet" %in% names(.)) format(100*`KilledP_Andet`/Total, digits = 0, trim = TRUE) else "0"}),
     Method = paste0(format(100*Flue/Total, digits = 0, trim = TRUE), "/", 
                    format(100*Spin/Total, digits = 0, trim = TRUE), "/", 
                    format(100*Orm/Total, digits = 0, trim = TRUE), "/", 
                    {if ("Andet" %in% names(.)) format(100*`Andet`/Total, digits = 0, trim = TRUE) else "0"}),
     Released = paste0(round(100*Released/Total, 0), "/", 
                       round(100*Killed/Total, 0)),
     Length = paste0(round(LengthAvg,0), "/", round(LengthMax,0)), 
     Weight = paste0(round(WeightAvg,1), "/", round(WeightMax,1), "/", round(Kg,0)), 
     Fulton = paste0(round(FultonAvg,2), "/", round(FultonMax,2))) %>%
  mutate_if(is.character, str_replace_all, pattern = "NaN|NA", replacement = "0")


#### Waterlevels ####
datWLevel <- read_csv(paste0(prefix, "data_skjern_waterlevel_relative_long_", year(now()), ".csv"))

#### Lock flow ####
datFlow <- read_csv(paste0(prefix, "data_skjern_flow_lock.csv"), locale = locale(tz = "CET"))
```

Fangster {data-navmenu="Laks"}
=======================================================================

Row
-----------------------------------------------------------------------

### Fangster i dag {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = datCatchSalmon %>% dplyr::filter(Date == date(now())) %>% nrow(),
    icon = "fa-chart-line",
    color = "primary"
  )
})
```

### Fangster seneste syv dage {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = datCatchSalmon %>% dplyr::filter(Date > now() - days(7)) %>% nrow(),
    icon = "fa-chart-line",
    color = "primary"
  )
})
```

### Fangster i år (hjemtaget/genudsat) {.value-box}

```{r}
renderValueBox({
  total <- datCatchSalmon %>% dplyr::filter(year(Date) == year(now())) %>% nrow()
  killed <- datCatchSalmon %>% dplyr::filter(year(Date) == year(now()), Killed == TRUE) %>% nrow()
  valueBox(
    value = str_c(total, " (", format(100*killed/total, digits = 0), "%/", format(100*(total - killed)/total, digits = 0) , "%)"),
    icon = "fa-fish",
    color = "warning"
  )
})
```

### Største laks i år {.value-box}

```{r}
renderValueBox({
  ct <- datCatchSalmon %>% dplyr::filter(year(Date) == year(now())) %>% 
    dplyr::filter(Weight == max(Weight, na.rm = T)) %>% arrange(Weight, Length)
  valueBox(
    caption = paste("Største laks i år fanget af", ct$Name[1]),
    value = paste(ct$Weight[1], "kg og", ct$Length[1], "cm"),
    icon = "fa-trophy",
    color = "success"
  )
})
```

Row 
-----------------------------------------------------------------------

### Seneste fangster
```{r Catches table}
DT::renderDataTable(
  DT::datatable(
    datCatchSalmon %>% select(Date:Method, Fulton, Misc, NoWeight),
    class = 'stripe row-border order-column nowrap compact', # nowrap display compact
    rownames = FALSE,
    filter = 'bottom',
    escape = FALSE,
    options = list(pageLength = 15, order = list(list(0, 'desc')),
                   list(visible=FALSE, targets="NoWeight"),
                   # autoWidth = TRUE,
                   columnDefs = list(
                     list(className = 'dt-center', targets = 0:7),
                     list(visible=FALSE, targets=c(8))
                   )
              ),
    colnames = c('Dato', 'Længde', 'Vægt', 'Navn', 'Sted', 'Metode', 'Kondition', 'Diverse', 'NoWeight'),
    extensions = c('Responsive')  #,'FixedHeader','RowGroup'
  ) %>%
  formatStyle(columns = 'Weight', valueColumns = 'NoWeight', color = styleEqual(c(0, 1), c("black","green"))) %>% 
  formatDate('Date', 'toLocaleDateString', params = list('da-DK')) %>%
  formatRound(c('Length'), digits = 0) %>%
  formatRound(c('Weight'), digits = 1) %>%
  formatRound(c('Fulton'), digits = 2)
)
```
 


Fangster {data-navmenu="Havørred"}
=======================================================================

Row
-----------------------------------------------------------------------

### Fangster seneste syv dage {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = datCatchTrout %>% dplyr::filter(Date > now() - days(7)) %>% nrow(),
    icon = "fa-chart-line",
    color = "primary"
  )
})
```

### Fangster i år {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = datCatchTrout %>% dplyr::filter(year(Date) == year(now())) %>% nrow(),
    icon = "fa-fish",
    color = "warning"
  )
})
```

### Største laks i år {.value-box}

```{r}
renderValueBox({
  ct <- datCatchTrout %>% dplyr::filter(year(Date) == year(now())) %>% 
    dplyr::filter(Weight == max(Weight, na.rm = T)) %>% arrange(Weight, Length)
  valueBox(
    caption = paste("Største havørred i år fanget af", ct$Name[1]),
    value = paste(ct$Weight[1], "kg og", ct$Length[1], "cm"),
    icon = "fa-trophy",
    color = "success"
  )
})
```

Row 
-----------------------------------------------------------------------

### Seneste fangster
```{r}
  DT::renderDataTable(
    DT::datatable(
    datCatchTrout[,c(1:6,9,10,14)],
    class = 'stripe row-border order-column nowrap compact', # nowrap display compact
    rownames = FALSE,
    filter = 'bottom',
    escape = FALSE,
    options = list(pageLength = 15, order = list(list(0, 'desc')),
                   list(visible=FALSE, targets="NoWeight"),
                   # autoWidth = TRUE,
                   columnDefs = list(
                     list(className = 'dt-center', targets = 0:7),
                     list(visible=FALSE, targets=c(8))
                   )
              ),
    colnames = c('Dato', 'Længde', 'Vægt', 'Navn', 'Sted', 'Metode', 'Kondition', 'Diverse', 'NoWeight'),
    extensions = c('Responsive')  #,'FixedHeader','RowGroup'
  ) %>%
  formatStyle(columns = 'Weight', valueColumns = 'NoWeight', color = styleEqual(c(0, 1), c("black","green"))) %>% 
  formatDate('Date', 'toLocaleDateString', params = list('da-DK')) %>%
  formatRound(c('Length'), digits = 0) %>%
  formatRound(c('Weight'), digits = 1) %>%
  formatRound(c('Fulton'), digits = 2)
)
```






Estimat af vægt {data-navmenu="Laks"}
=======================================================================
  
Row
-----------------------------------------------------------------------
  
### Estimat af vægt (kg) givet længde (cm) og måned
  
```{r}
tab <- 
  datWeightSalmon %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Avg) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab1 <- 
  datWeightSalmon %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Lower) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, " [", .y))

tab1 <- datWeightSalmon %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Upper) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, ",", .y, "]")) %>% 
  mutate(Length = str_remove(Length, " .*")) %>% 
  select(Length, ncol(.):2) 
  
monthNames <- c("Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
colnames(tab) <- c("Længde", monthNames[4:(ncol(tab) + 2)])

tab %>% 
  kable(align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Row
-----------------------------------------------------------------------

### Plot af vægt givet længde
  
```{r salmon weight estimate}
renderPlot({
  ggplot(datWeightSalmon, aes(x = Length, y = Avg)) + 
    geom_line(aes(group = Period, color = Period)) +
    labs(title = "", color = "") +
    ylab("Vægt (kg)") + xlab("Længde (cm)") + 
    guides(col = guide_legend(ncol = 7)) + 
    theme(legend.position="bottom")  
    # scale_color_brewer(palette = "Set1") +
    # scale_color_discrete(name = "", labels = c("Sep-Okt", "Marts", "Apr-Aug"))
})
```



Estimat af vægt {data-navmenu="Havørred"}
=======================================================================
  
Row
-----------------------------------------------------------------------
  
### Estimat af vægt (kg) givet længde (cm) og måned
  
```{r}
tab <- 
  datWeightTrout %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Avg) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab1 <- 
  datWeightTrout %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Lower) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, " [", .y))

tab1 <- datWeightTrout %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Upper) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, ",", .y, "]")) %>% 
  mutate(Length = str_remove(Length, " .*")) %>% 
  select(Length, ncol(.):2) 
  
monthNames <- c("Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
colnames(tab) <- c("Længde", monthNames[4:(ncol(tab) + 2)])

tab %>% 
  kable(align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Row
-----------------------------------------------------------------------

### Plot af vægt givet længde
  
```{r seatrout weight estimate}
renderPlot({
  ggplot(datWeightTrout, aes(x = Length, y = Avg)) + 
    geom_line(aes(group = Period, color = Period)) +
    labs(title = "", color = "") +
    ylab("Vægt (kg)") + xlab("Længde (cm)") + 
    guides(col = guide_legend(ncol = 7)) + 
    theme(legend.position="bottom")  
    # scale_color_brewer(palette = "Set1") +
    # scale_color_discrete(name = "", labels = c("Sep-Okt", "Marts", "Apr-Aug"))
})
```
  

  

Nuværende {data-navmenu="Vandstand"}
=======================================================================
  
### Relativ vandstand i forhold til gennemsnit (rullende over 90 dage)

```{r}
renderPlot({
  datS <- datWLevel %>% 
    dplyr::filter(Date > now() - days(14)) %>% 
    dplyr::filter(str_detect(Place, "Skjern|Rind"))
  ggplot(data = datS, aes(x = Date, y = Level)) + 
    geom_hline(yintercept = 0, colour="black") +
    # geom_smooth(aes(group = Group), na.rm = T, method = lm, formula = y ~ splines::bs(x, 40), 
    #             se = FALSE, color = "grey", lwd=0.5) +
    geom_line(na.rm = T, colour = "#00AFBB") + 
    facet_grid(rows = vars(Place)) +
    # labs(title = "Relativ vandstand i Karup Å", 
    #      subtitle = "Vandstand relativ i forhold til gennemsnit over 90 dage") +
    ylab("Relativ vandstand (m)") + xlab("Dato") +
    theme(legend.position="bottom") 
})
# renderPlotly(ggplotly(pWMA) %>%  layout(legend = list(orientation = "h", x = 0.3, y = -0.4)))
```

Over år {data-navmenu="Vandstand"}
=======================================================================

Row
-----------------------------------------------------------------------
  
### Vandstand over år
  
```{r Vandstand årlig}
renderPlot({
  readGHWLevels <- function(years) {
    dat <- NULL
    for (y in years) {
      fn <- paste0(prefix, "data_skjern_waterlevel_relative_long_", y, ".csv")
      dat <- bind_rows(dat, read_csv(fn))
    }
    return(dat)
  }
  datWLevelAllL <- readGHWLevels(2017:2020)
  
  # datWLevelL <- datWLevel %>%
  #   pivot_longer(cols = contains(c('K','H')), names_to = 'Group', values_to = 'Level') %>%
  #   mutate(Sted = case_when(
  #     grepl("Karup", Group, fixed = T) ~ "Karup By",
  #     grepl("Nør", Group, fixed = T) ~ "Nørkærbro",
  #     grepl("Hage", Group, fixed = T) ~ "Hagebro",
  #     TRUE ~ "??"),
  #     Type = if_else(grepl("Avg", Group, fixed = T), "gens", "måling")
  #   )
  ggplot(data = datWLevelAllL, aes(x = Date, y = Level)) +
    geom_line(aes(), na.rm = T) +
    facet_grid(rows = vars(Place), scales = "free") +
    # labs(title = "Vandstand i Karup Å",
    #      subtitle = "Gennemsnit er beregnet over 90 dage (givet data for alle år)") +
    theme(legend.position="bottom") +
    ylab("Relativ vandstand (m)") + xlab("Dato") 
})
```



Statistik `r year(now())` {data-navmenu="Laks"}
=======================================================================

Row
-----------------------------------------------------------------------

### Opsumering

```{r}
cNames <- c(paste0(faIcon("calendar-alt", class = "far", title = "Måned")), 
   "<i class=\"fas\" title=\"Total antal\">&#x3A3;</i>",
   # paste0(faIcon("mars", title = "Han"),"/",
   #        faIcon("venus", title = "Hun"), "/",
   #        faIcon("question", title = "Ukendt"), " (%)"),
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Flue'>F</span>/<span title='Spin'>S</span>/<span title='Orm'>O</span>/<span title='Andet'>A</span> (%)",
   paste0(faIcon("sync", title = "C&R"),"/",
          faIcon("times", title = "Hjemtaget"), " (%)"),
   paste0(faIcon("ruler-horizontal", title="Gens længde"), "/",
          faIcon("ruler", title="Max længde")),
   paste0(faIcon("balance-scale", title="Gens. vægt"), "/",
          faIcon("weight-hanging", title="Max vægt"),
          "/<i class=\"fas\" title=\"Total vægt\">&#x3A3;</i>"),
   paste0(faIcon("heart", title="Gens kondition"), "/",
          faIcon("gratipay", title="Max kondition"))
   ) 

datStatMonthSalmon %>% 
  kable(col.names = cNames, escape = F, align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```


Row
-----------------------------------------------------------------------

### Fangster den seneste måned

```{r}
renderPlot({
  dat <- datCatchSalmon %>% 
    dplyr::filter(Date > now() - days(30)) %>% 
    select(Date, Place) %>% 
    arrange(desc(Date))

  ggplot(data = dat, aes(x = Date)) +
    geom_bar(aes(fill = Place)) + 
    scale_x_date(date_labels = "%e. %b", date_breaks = "1 day", limits = c(NA_Date_, date(now()+ddays(1)))) + 
    labs(fill = "") + xlab("Dato") + ylab("Antal fangster") + 
    theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
 })
```


Row
-----------------------------------------------------------------------

### Ugentlige fangster `r year(now())`

```{r}
renderPlot({
  dat <- datCatchSalmon %>% 
    dplyr::filter(Date > ymd(paste0(year(now()),"-01-01"))) %>% 
    select(Week, Place)
  
  ggplot(data = dat, aes(x = Week)) +
    geom_bar(aes(fill = Place)) + 
    geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", vjust = -.5) +
    expand_limits(x = week(now())) + 
    labs(fill = "") + xlab("Uge") + ylab("Antal fangster") + 
    theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
})
```

### Månedlige fangster `r year(now())`

```{r}
renderPlot({
  dat <- datCatchSalmon %>% 
    dplyr::filter(Date > ymd(paste0(year(now()),"-01-01"))) %>% 
    select(Month, Place)
  
ggplot(dat, aes(x = Month)) + 
     geom_bar(aes(fill = Place), stat="count") +
     geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", vjust = -.5) +
     expand_limits(x = month(now(), label = T)) + 
     labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
     theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
})
```

Statistik over år {data-navmenu="Laks"}
=======================================================================

Row
-----------------------------------------------------------------------

### Statistik over år

```{r}
cNames <- c(paste0(faIcon("calendar-alt", class = "far", title = "Måned")), 
   "<i class=\"fas\" title=\"Total antal\">&#x3A3;</i>",
   # paste0(faIcon("mars", title = "Han"),"/",
   #        faIcon("venus", title = "Hun"), "/",
   #        faIcon("question", title = "Ukendt"), " (%)"),
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Flue'>F</span>/<span title='Spin'>S</span>/<span title='Orm'>O</span>/<span title='Andet'>A</span> (%)",
   paste0(faIcon("sync", title = "C&R"),"/",
          faIcon("times", title = "Hjemtaget"), " (%)"),
   paste0(faIcon("ruler-horizontal", title="Gens længde"), "/",
          faIcon("ruler", title="Max længde")),
   paste0(faIcon("balance-scale", title="Gens. vægt"), "/",
          faIcon("weight-hanging", title="Max vægt"),
          "/<i class=\"fas\" title=\"Total vægt\">&#x3A3;</i>"),
   paste0(faIcon("heart", title="Gens kondition"), "/",
          faIcon("gratipay", title="Max kondition"))
   ) 

datStatYearSalmon %>% 
  kable(col.names = cNames, escape = F, align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))

# tabStat <- 
#   datStatYearSalmon %>% 
#   transmute(Year, Total, 
#          Sex = paste0(format(100*Male/Total, digits = 0, trim = TRUE), "/", 
#                       format(100*Female/Total, digits = 0, trim = TRUE), "/", 
#                       format(100*SexUnknown/Total, digits = 0, trim = TRUE)), 
#          Place = paste0(format(100*Lower/Total, digits = 0, trim = TRUE), "/", 
#                         format(100*Middle/Total, digits = 0, trim = TRUE), "/", 
#                         format(100*Upper/Total, digits = 0, trim = TRUE), "/", 
#                         format(100*Haderis/Total, digits = 0, trim = TRUE)),
#          Released = paste0(round(100*Released/Total, 0), "/", 
#                            round(100*Killed/Total, 0), "/", 
#                            round(100*KilledUnknown/Total, 0)),
#          LengthAvg = round(LengthAvg,0), 
#          LengthMax = round(LengthMax,0), 
#          WeightAvg = round(WeightAvg,1), 
#          WeightMax = round(WeightMax,1), 
#          Kg = round(Kg,0), 
#          FultonAvg = round(FultonAvg,2)) %>% 
#   arrange(desc(Year))
# # names(tabStat) <- c("År", "Total", "Hun/Han/? (%)", "N/M/Ø/H (%)", "C&R (%)", "Hjemtaget (%)", "Gens. længde", "Max længde", "Gens. vægt", "Max vægt", "Total Kg", "Gens. Kondition")
# 
# # renderDT(
#   DT::datatable(
#     tabStat,
#     colnames = c("År", "Total", 
#                  "<img src='www/boy.gif' alt='Han'>/<img src='www/girl.gif' alt='Han'>/? (%)", 
#                  "N/M/Ø/H (%)", 
#                  "<img src='www/c_and_r.gif' alt='C&R'>/K (%)", 
#                  "Gens. længde", 
#                  "Max længde", "Gens. vægt", "Max vægt", "Total Kg", "Gens. Kondition"),
#     class = 'nowrap display', # nowrap display compact stripe row-border order-column
#     rownames = FALSE,
#     escape = FALSE,
#     fillContainer = TRUE,
#     selection = "none",
#     options = list(#autoWidth = TRUE,
#       paging = FALSE, bSort = FALSE, dom = 'tip' #scrollX = TRUE, scrollY = TRUE, scrollCollapse=TRUE
#       # columnDefs = list(list(className = 'dt-center', targets = 2:7))
#               ),
#     extensions = c('Responsive')
#   )
# )
```




Row
-----------------------------------------------------------------------

### Månedlige fangster givet sted 2004-`r year(now())`

```{r}
renderPlot({
  dat <- datCatchSalmon %>% select(Month, Place)
  
  ggplot(data = dat, aes(x = Month)) +
    geom_bar(aes(fill = Place, y = (..count..)/sum(..count..))) + 
    geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),2)),
                   y = (..count..)/sum(..count..)), stat= "count", vjust = -.5) +
    labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
    scale_y_continuous(labels = scales::percent) + 
    guides(fill = guide_legend(ncol = 6)) + 
    theme(legend.position="bottom")  # axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), 
})
```

### Månedlige fangster givet metode 2004-`r year(now())`

```{r}
renderPlot({
  dat <- datCatchSalmon %>% select(Month, Method)
  
  ggplot(data = dat, aes(x = Month)) +
    geom_bar(aes(fill = Method, y = (..count..)/sum(..count..))) + 
    geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),2)),
                   y = (..count..)/sum(..count..)), stat= "count", vjust = -.5) +
    labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
    scale_y_continuous(labels = scales::percent) + 
    guides(fill = guide_legend(ncol = 4)) + 
    theme(legend.position="bottom")  # axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), 
})
```




Sammenlign {data-navmenu="Laks"}
=======================================================================

Row {data-height=350}
-----------------------------------------------------------------------

### Vælg årstal: 
```{r}
sliderInput("iInvYear", label = "",
            min = 2004, max = year(now()), sep = "",
            value = c(2016, year(now())), step = 1)
```

### Vælg dato interval: 
```{r}
sliderInput("iInvDay", label = "",
            min = as.Date("2019-04-01"), max = as.Date("2019-10-31"), 
            value = c(as.Date("2019-04-01"), as.Date("2019-10-31")), step = 1,
            timeFormat = "%d %b")
```

### Vælg enhed på x-aksen: 
```{r}
cIXUnit <- c("Dag" = "Day", "Uge" = "Week", "Måned" = "Month", "År" = "Year")
selectInput("iXUnit", "", cIXUnit, selected = "Year")
```

### Vælg enhed på y-aksen: 
```{r}
cIYUnit <- c("Fisk fanget" = "yVTotal",
                  "Max længde" = "yVMaxL",
                  "Gennemsnitlig længde" = "yVAvgL",
                  "Max vægt" = "yVMaxW",
                  "Gennemsnitlig vægt" = "yVAvgW")
selectInput("iYUnit", "", cIYUnit)
```

### Vælg gruppe inddeling: 
```{r}
cIGroup <- c("Område" = "Place",
                  "Metode" = "Method",
                  "Ingen" = "None")
selectInput("iGroup", "", cIGroup, "None")
```


Row {data-height=1000}
-----------------------------------------------------------------------

### Sammenligning

```{r}
renderPlot({
  
# input <- NULL
# input$iInvYear <- c(2018,2019)
# input$iInvDay <- c("2019-04-16", "2019-04-25")
# input$iXUnit <- "Day"  # Day
# input$iYUnit <- "yVAvgW"
# input$iGroup <- "Method"

if (input$iXUnit == "Day") 
  iXUnit <- "DayStr" 
else if (input$iXUnit == "Year")
  iXUnit <- "None"
else
  iXUnit <- input$iXUnit

dat <- 
  datCatchSalmon %>% 
  dplyr::filter(Year >= input$iInvYear[1], Year <= input$iInvYear[2],
                  Day >= yday(ymd(str_c(input$iInvYear[1],"-",month(input$iInvDay[1]),"-",day(input$iInvDay[1])))),
                  Day <= yday(ymd(str_c(input$iInvYear[2],"-",month(input$iInvDay[2]),"-",day(input$iInvDay[2]))))
                  ) %>% 
  # select(!!input$iXUnit, Place, Year, Length, Weight, !!iXUnit) %>% 
  mutate(None = "", xV = str_c(.data[[iXUnit]], " ", Year), grp = .data[[input$iGroup]]) %>% 
  group_by_at(c("xV", "grp", input$iXUnit)) %>%
  summarise(yVTotal = n(),
            yVMaxW = max(Weight, na.rm = T), 
            yVMaxL = max(Length, na.rm = T),
            yVAvgW = round(mean(Weight, na.rm = T),1), 
            yVAvgL = round(mean(Length, na.rm = T),0),
            ) %>% 
  mutate(yV = .data[[input$iYUnit]]) %>% 
  arrange_at(c(input$iXUnit, "xV")) %>% 
  group_by(xV) %>% 
  mutate(pct = sum(yVTotal)) %>% 
  group_by_at(c("xV", "grp", input$iXUnit)) %>% 
  mutate(label = str_c(round(100*yVTotal/pct, 0), "%"))

if (input$iGroup == "None") dat <- dat %>% mutate(label = yV)
xLab <- names(cIXUnit)[grep(input$iXUnit, cIXUnit)]
yLab <- names(cIYUnit)[grep(input$iYUnit, cIYUnit)]
dat$xV <- factor(dat$xV, levels = unique(dat$xV[order(dat[[input$iXUnit]], dat$xV)]))
ggplot(data = dat, aes(x = xV, y = yV)) +
  geom_col(aes(fill = grp), position = position_dodge2(preserve = "single")) +
  # geom_text(aes(label = yV, y = 1.05*yV), position = position_dodge2(width = 0.9)) + 
  geom_text(aes(label = label, y = 1.05*yV), position = position_dodge2(width = 0.9), cex = 3)  +  #, vjust = "inward", hjust = "inward"
  labs(fill = "") + xlab(xLab) + ylab(yLab) +
  theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
})
```



Slusen
=======================================================================

```{r}
# Find high and lows
findPeaks <- function (x, m = 2){
    shape <- diff(sign(diff(x, na.pad = FALSE)))
    pks <- sapply(which(shape < 0 | shape > 0), FUN = function(i){
       z <- i - m + 1
       z <- ifelse(z > 0, z, 1)
       w <- i + m + 1
       w <- ifelse(w < length(x), w, length(x))
       if(all(x[c(z : i, (i + 2) : w)] <= x[i + 1]) | all(x[c(z : i, (i + 2) : w)] >= x[i + 1])) return(i + 1) else return(numeric(0))
    })
     pks <- unlist(pks)
     pks <- unique(c(1, pks, length(x)))
     pks
}

setAvgFlow <- function(x) {
  idx <- findPeaks(x)
  res <- rep(0, length(x))
  for (j in 1:(length(idx)-1)) {
    # cat("j:",j,"i:",idx[j],"x:",x[idx[j]],"j+1:",j+1,"i:",idx[j+1],"x:",x[idx[j+1]],"\n")
    if (max(x[idx[j]], x[idx[j+1]]) < -100 | 
        max(x[idx[j]], x[idx[j+1]]) > 100 |
        min(x[idx[j]], x[idx[j+1]]) > 100 |
        min(x[idx[j]], x[idx[j+1]]) < -100
        ) {
      res[idx[j]:idx[j+1]] <- 2
      next
    }
    if (abs((x[idx[j+1]] - x[idx[j]])/(idx[j+1] - idx[j])) > 0.5 |
        max(x[idx[j]], x[idx[j+1]]) > 10 |
        min(x[idx[j]], x[idx[j+1]]) < -10
        ) {
      v1 <- res[idx[j]]
      v2 <- res[idx[j+1]] 
      res[idx[j]:idx[j+1]] <- 1
      if (v1 == 2) res[idx[j]] <- 2
      if (v2 == 2) res[idx[j+1]] <- 2
      next
    }
  }
  return(res)
}

datFlow14 <- datFlow %>% 
  dplyr::filter(DateTime > now() - days(14)) %>% 
  mutate(Open = setAvgFlow(.$Flow))
```

Row
-----------------------------------------------------------------------

### Åben de seneste 7 dage {.value-box}

```{r}
rate <- datFlow14 %>% 
  dplyr::filter(DateTime > now() - days(7)) %>% 
  # summarise(Rate = 100*sum(Open)/(2*n())) %>% 
  summarise(Rate = 100*sum(Open>0)/(n())) %>% 
  as.numeric() %>% round(0)
gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(75, 100), warning = c(25, 75), danger = c(0, 25)
))
```

### Åben de seneste 14 dage {.value-box}

```{r}
rate <- datFlow14 %>% 
  # summarise(Rate = 100*sum(Open)/(2*n())) %>% 
  summarise(Rate = 100*sum(Open>0)/(n())) %>% 
  as.numeric() %>% round(0)
gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(75, 100), warning = c(25, 75), danger = c(0, 25)
))
```

Row
-----------------------------------------------------------------------

### Sluse flow de seneste 14 dage (strøm ind i fjorden er positiv)

```{r}
renderPlot({
  ggplot(datFlow14) + 
    # geom_bar(aes(x = DateTime, y = 100*Open), stat = "identity") +
    geom_line(aes(x = DateTime, y = Flow, colour = Open)) + 
    # scale_colour_gradient2(low = "red", mid = "yellow", high = "green", na.value = NA, midpoint = 1, guide = "legend") +
    # geom_point(aes(x = DateTime, y = Flow), data = dat[findPeaks(dat$Flow),]) +
    scale_colour_gradient(low = "red", high = "green", na.value = NA, guide = "legend", breaks = c(0,1,2), name = "", labels = c("Lukket", "Delvis åben", "Åben")) +
    # guide_coloursteps(even.steps = TRUE, show.limits = NULL, ticks = FALSE) +
    theme(legend.position="bottom") +
    labs(x = "Dato", y = "Flow (m3/s)")  #title = "Sluseflow Hvide Sande"
})
```


Vejret
=======================================================================

Row
-----------------------------------------------------------------------

### Vejret

Vejrkort

* [Windfinder nedre](https://www.windfinder.com/#13/55.9251/8.4928/sfc){target="_blank"}
* [Windfinder mellem](https://www.windfinder.com/#13/55.9376/8.6507/sfc){target="_blank"}
* [Windfinder øvre](https://www.windfinder.com/#13/55.9652/8.8720/sfc){target="_blank"}
* [Windy](https://www.windy.com/55.959/8.645?55.925,8.545,13){target="_blank"}

Lokale vejrudsigter

* [Yr Arnborg](https://www.yr.no/sted/Danmark/Midtjylland/Arnborg/){target="_blank"}
* [DMI Arnborg](https://www.dmi.dk/lokation/show/DK/2624622/Arnborg/){target="_blank"}
* [Yr Sdr. Felding](https://www.yr.no/sted/Danmark/Midtjylland/S%C3%B8nder_Felding/){target="_blank"}
* [DMI Sdr. Felding](https://www.dmi.dk/lokation/show/DK/2613064/S%C3%B8nder_Felding/){target="_blank"}
* [Yr Borris](https://www.yr.no/sted/Danmark/Midtjylland/Borris/){target="_blank"}
* [DMI Borris](https://www.dmi.dk/lokation/show/DK/2623640/Borris/){target="_blank"}
* [Yr Skjern](https://www.yr.no/sted/Danmark/Midtjylland/Skjern/){target="_blank"}
* [DMI Skjern](https://www.dmi.dk/lokation/show/DK/2613715/Skjern/){target="_blank"}

Om siden 
=======================================================================

Row
-----------------------------------------------------------------------

### Info

Dette dashboard er lavet af Lars Relund og giver information omkring fiskeriet i Skjern Å. Data er hentet fra forskellige kilder. Fangst data er fra SÅS. Der er data fra 2004. Kun laks og havørred over mindstemålet vises under fangster. Å systemet er opdelt i zoner Nedre (fra udløbet of opstrøms til Borris Krog bro), Mellem (fra Borris Krog Bro til Tarp Bro), Øvre (Opstrøms Tarp Bro), Vorgod Å, Omme Å samt Andet (andre områder). Kondition er beregnet udfra [Fultons formel](http://ulnits.dk/biologi/the-k-factor/).  

Vægten for genudsatte fisk er [estimeret](#estimat-af-vægt) udfra tidligere fangster og givet i grøn farve. For mere info se denne [rapport](http://htmlpreview.github.io/?https://github.com/relund/skjern/blob/master/reports/skjern_weight.html).

Vandstandsdata er fra [vandløbssiden](http://www.hydrometri.dk/hyd/). Den gennemensnitlige vandstand er estimeret som et rullende gennemsnit over 90 dage (45 dage på hver side af datoen) ved brug af tilgængelige data for alle år. Bemærk den gennemsnitlige vandstand siger nødvendigvis ikke noget om en god vandstand for fiskeriet, fx kan den gennemsnitlige vandstand i vinterhalvåret godt være høj.

Sluse data er fra [vejrstationen i Hvide Sande](http://hyde.dk/Sflow/default_flow.asp). Slusen er defineret som "Delvis åben" når flowet er lavt hvilket ofte skyldes få åbne porter.  

Forslag til forbedringer kan sendes til lars.relund[at]gmail[dot]com.
  