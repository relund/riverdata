---
title: "Dashboard Skjern Å"
author: ''
output:
  flexdashboard::flex_dashboard:
    css: www/style.css
    favicon: favicon.png
    orientation: rows
    theme: paper
    vertical_layout: fill
resource_files:
- www/boy.gif
- www/c_and_r.gif
- www/cut.gif
- www/foto.gif
- www/girl.gif
- www/info.png
- www/net.gif
runtime: shiny_prerendered
editor_options:
  chunk_output_type: console
---

<script>
$(".selectize-input input").prop('readonly','readonly');
</script>

```{r, context="setup", include=FALSE}
#profvis({rmarkdown::run("karup.Rmd", shiny_args = list(host="0.0.0.0", port=5050))})
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
#library(ggrepel)
library(directlabels)
library(plotly)
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(shiny)
library(DT)
# library(formattable)
library(flextable)
library(shinyBS)
library(kableExtra)
# library(zoo) 
library(leaflet)

source("functions.R")

faIcon <- function (name, class = "", title = "", lib = "font-awesome") 
{
    prefixes <- list(`font-awesome` = "fa", glyphicon = "glyphicon")
    prefix <- prefixes[[lib]]
    if (is.null(prefix)) {
        stop("Unknown font library '", lib, "' specified. Must be one of ", 
            paste0("\"", names(prefixes), "\"", collapse = ", "))
    }
    if (class != "") class = paste0(" ", class)
    prefix_class <- prefix
    if (prefix_class == "fa" && name %in% shiny:::font_awesome_brands) {
        prefix_class <- "fab"
    } else if (prefix_class == "fa") prefix_class <- "fas"
    iconClass <- paste0(prefix_class, " ", prefix, "-", name, class)
    iconTag <- tags$i(class = iconClass, title = title)
    htmltools::htmlDependencies(iconTag) <- htmltools::htmlDependency("font-awesome", 
        "5.3.1", "www/shared/fontawesome", package = "shiny", 
        stylesheet = c("css/all.min.css", "css/v4-shims.min.css"))
    htmltools::browsable(iconTag)
}
addResourcePath('www', paste0(getwd(), "/www"))
```


```{r, context="data", include=FALSE}  
prefix <- "https://raw.githubusercontent.com/relund/skjern/master/data/"
curYear <- if_else(month(now())*100 + day(now()) < 416, year(now())-1, year(now()))   # assume previous year until season starts

# Weight - Estimates 
datWeightSea<- read_csv(paste0(prefix, "data_skjern_weight_seatrout.csv"))
datWeightSal <- read_csv(paste0(prefix, "data_skjern_weight_salmon.csv"))

# Catch - Records 
datCatchSal <- readCatch(paste0(prefix, "data_skjern_catch_salmon.csv"), datWeightSal)
datCatchSea <- readCatch(paste0(prefix, "data_skjern_catch_seatrout.csv"), datWeightSea)

# Catch - Yearly statistics
datStatYearSal <- yearlyStat(datCatchSal)
datStatYearSea <- yearlyStat(datCatchSea)

# Catch - Monthly statistics
datStatMonthSal <- monthlyStat(datCatchSal, curYear)
datStatMonthSea <- monthlyStat(datCatchSea, curYear)

# Water levels 
datWLevel <- 
  read_csv(paste0(prefix, "data_skjern_waterlevel_web.csv"), col_types = "Tffdd") 
  #dplyr::filter(str_detect(Place, "Skjern|Rind"))

# Lock flow
datFlow <- read_csv(paste0(prefix, "data_skjern_flow_lock_web.csv"), 
                    locale = locale(tz = "CET"),
                    col_types = "Tdd")

# Maps data
mapAddMarkers <- function(map, group, data) {
  if (nrow(data) == 0) return(map)
  map <- map %>% 
    addMarkers(~long, ~lat, label = ~Desc, popup = ~Desc,
               icon = ~icons(Icon, iconWidth = 32, iconHeight = 32, iconAnchorX = 16, iconAnchorY = 16), 
               group = group,
               clusterOptions = markerClusterOptions(showCoverageOnHover = FALSE),
               data = data)
  groups <<- c(groups, group)
  return(map)
}

mapAddLines <- function(map, group, data, color, useClub = TRUE) {
  if (nrow(data) == 0) return(map)
  dat <- data %>% group_by(LineGroupId, Desc, Club) %>% nest()
  map(1:nrow(dat), function(i) {
    group <- if_else(useClub, str_c(dat$Club[i], " (", group, ")"), group)
    map <<- map %>%
      addPolylines(~long, ~lat, label = ~Desc, popup = ~Desc,
                   group = group, color = color, weight = 1.5, opacity = 0.75,
                   data = dat[i,] %>% unnest(col = c(data)))
    groups <<- c(groups, group)
    return(invisible(NULL))
  })
  return(map)
}

datMarkers <- read_csv(paste0(prefix, "data_skjern_mapmarkers.csv"), col_types = "fccddff") %>% 
  mutate(Desc = str_c(if_else(!is.na(Desc), str_c("<b>", Desc, "</b>"), "", ""), 
                       if_else(!is.na(Text), str_c("<br/><br/>", Text), "", ""))) %>% 
  mutate(Desc = str_replace(Desc, "^(.*?)(http.*)([\\s$]*.*)", "\\1<a href='\\2'>\\2</a>\\3")) %>% 
  mutate(Desc = map(Desc, HTML), Icon = str_c("www/", Icon), Id = 1:n()) %>% 
  select(-Text) 
  
datLines <- read_csv(paste0(prefix, "data_skjern_maplines.csv"), col_types = "fccddif")  %>%  
  mutate(Desc = str_c(if_else(!is.na(Desc), str_c("<b>", Desc, "</b>"), "", ""), 
                       if_else(!is.na(Text), str_c("<br/><br/>", Text), "", ""))) %>% 
  mutate(Desc = str_replace(Desc, "^(.*?)(http.*)([\\s$]*.*)", "\\1<a href='\\2'>\\2</a>\\3")) %>% 
  mutate(Desc = map(Desc, HTML)) %>% 
  select(-Text) 

maplet <- leaflet() %>% 
  # Base groups
  addTiles(group = "Kort") %>%
  # addProviderTiles('MtbMap', group = "Kort") %>% 
  addProviderTiles('Esri.WorldImagery', group = "Luftfoto") %>% 
  addProviderTiles("CartoDB.PositronOnlyLabels", group = "Luftfoto") 
  # setView(9.016712672451805, 56.40970340006212,  zoom = 13) 

groups <- NULL
# Markers
Ids <- datMarkers %>% 
  filter(
    str_detect(Group, regex("Parkering", ignore_case = T)) | 
      str_detect(Desc, regex("indhegning", ignore_case = T))) %>% 
  pull(Id)
maplet <- mapAddMarkers(maplet, "Parkering", datMarkers %>% filter(Id %in% Ids))
datMarkers <- datMarkers %>% filter(!(Id %in% Ids))

Ids <- datMarkers %>% 
  filter(
    str_detect(Group, regex("Standpladser|Sten|Spang|Bro|shelter", ignore_case = T)) | 
      str_detect(Desc, regex("hytte|laksens hus", ignore_case = T))) %>% 
  pull(Id)
maplet <- mapAddMarkers(maplet, "Stednavne", datMarkers %>% filter(Id %in% Ids))
datMarkers <- datMarkers %>% filter(!(Id %in% Ids))

Ids <- datMarkers %>% 
  filter(
    str_detect(Group, regex("Info", ignore_case = T))) %>% 
  pull(Id)
maplet <- mapAddMarkers(maplet, "Info", datMarkers %>% filter(Id %in% Ids))
datMarkers <- datMarkers %>% filter(!(Id %in% Ids))

# Lines
maplet <- mapAddLines(maplet, group = "Parkering", color = "#000000", useClub = FALSE,
                      data = datLines %>% 
                        filter(str_detect(Group, regex("parkering", ignore_case = T))))
maplet <- mapAddLines(maplet, group = "fiskevand", color = "#3C8AE6",
                      data = datLines %>% 
                        filter(str_detect(Group, regex("fiskevand", ignore_case = T))))
maplet <- mapAddLines(maplet, group = "medlem", color = "#EBE053",
                      data = datLines %>% 
                        filter(str_detect(Group, regex("medlem", ignore_case = T))))
maplet <- mapAddLines(maplet, group = "dagkort", color = "#eb9834",
                      data = datLines %>% 
                        filter(str_detect(Group, regex("dagkort", ignore_case = T))))
maplet <- mapAddLines(maplet, group = "gæstekort", color = "#bf5656",
                      data = datLines %>% 
                        filter(str_detect(Group, regex("gæstekort", ignore_case = T))))

maplet <- maplet %>% 
  # Layer control
  addLayersControl(
    baseGroups = c("Luftfoto", "Kort"),
    overlayGroups = unique(groups),
    options = layersControlOptions(collapsed = TRUE)
  ) %>% 
  hideGroup(groups) %>% 
  showGroup("Stednavne")
```

```{r, eval=FALSE}
verbatimTextOutput("hash")
query <- getQueryString()
```

```{r, context = "server", eval=FALSE}
output$hash <- renderText({
  query <- getQueryString()
  URLencode(str_c("?", str_c(names(query), query, sep = "=", collapse="&"), "#section-compare-sal"))
      })
```

Fangster `r curYear` {data-navmenu="Laks"}
=======================================================================

Row
-----------------------------------------------------------------------

### Fangster i dag {.value-box}

```{r}
valueBoxOutput("cSalToday")
```

```{r, context = "server", include=FALSE}
output$cSalToday <- renderValueBox({
  valueBox(
    value = datCatchSal %>% dplyr::filter(Date == date(now())) %>% nrow(),
    icon = "fa-chart-line",
    color = "primary"
  )
})
```

### Fangster seneste syv dage {.value-box}

```{r}
valueBoxOutput("cSalSeven")
```

```{r, context = "server", include=FALSE}
output$cSalSeven <- renderValueBox({
  valueBox(
    value = datCatchSal %>% dplyr::filter(Date > now() - days(7)) %>% nrow(),
    icon = "fa-chart-line",
    color = "primary"
  )
})
```

### Fangster i `r curYear` (hjemtaget/genudsat) {.value-box}

```{r}
valueBoxOutput("cSalYear")
```

```{r, context = "server"}
output$cSalYear <- renderValueBox({
  total <- datCatchSal %>% dplyr::filter(year(Date) == curYear) %>% nrow()
  killed <- datCatchSal %>% dplyr::filter(year(Date) == curYear, Killed == TRUE) %>% nrow()
  killedPct <- if_else(total > 0, format(100*killed/total, digits = 0), "0")
  releasedPct <- if_else(total > 0, format(100*(total - killed)/total, digits = 0), "0")
  valueBox(
    value = str_c(total, " (", killedPct, "%/", releasedPct, "%)"),
    icon = "fa-fish",
    color = "warning"
  )
})
```

### Største fisk `r curYear` {.value-box}

```{r}
valueBoxOutput("cSalBig")
```

```{r, context = "server"}
output$cSalBig <- renderValueBox({
  ct <- datCatchSal %>% dplyr::filter(year(Date) == curYear) %>% 
    dplyr::filter(Weight == max(Weight, na.rm = T)) %>% arrange(Weight, Length)
  val <- if_else(nrow(ct) > 0, paste(ct$Weight[1], "kg og", ct$Length[1], "cm"), "-")
  cap <- if_else(nrow(ct) > 0,paste("Største fisk i", curYear, "fanget af", ct$Name[1]), paste("Største fisk", curYear))  
  valueBox(
    caption = cap,
    value = val,
    icon = "fa-trophy",
    color = "success"
  )
})
```

<!-- Row  -->
<!-- ----------------------------------------------------------------------- -->

<!-- ### Seneste fangster -->

<!-- ```{r} -->
<!-- dataTableOutput("dTSalCatch") -->
<!-- ``` -->

<!-- ```{r, context = "server"} -->
<!-- output$dTSalCatch <- DT::renderDataTable( -->
<!--   DT::datatable( -->
<!--     datCatchSal %>% select(Date:Method, Fulton, Misc, NoWeight), -->
<!--     class = 'stripe row-border order-column nowrap compact', # nowrap display compact -->
<!--     rownames = FALSE, -->
<!--     filter = 'bottom', -->
<!--     escape = FALSE, -->
<!--     options = list(pageLength = 15, order = list(list(0, 'desc')), -->
<!--                    list(visible=FALSE, targets="NoWeight"), -->
<!--                    # autoWidth = TRUE, -->
<!--                    columnDefs = list( -->
<!--                      list(className = 'dt-center', targets = 0:7), -->
<!--                      list(visible=FALSE, targets=c(8)) -->
<!--                    ) -->
<!--               ), -->
<!--     colnames = c('Dato', 'Længde', 'Vægt', 'Navn', 'Sted', 'Metode', 'Kondition', 'Diverse', 'NoWeight'), -->
<!--     extensions = c('Responsive')  #,'FixedHeader','RowGroup' -->
<!--   ) %>% -->
<!--   formatStyle(columns = 'Weight', valueColumns = 'NoWeight', color = styleEqual(c(0, 1), c("black","green"))) %>%  -->
<!--   formatDate('Date', 'toLocaleDateString', params = list('da-DK')) %>% -->
<!--   formatRound(c('Length'), digits = 0) %>% -->
<!--   formatRound(c('Weight'), digits = 1) %>% -->
<!--   formatRound(c('Fulton'), digits = 2) -->
<!-- ) -->
<!-- ``` -->

Row
-----------------------------------------------------------------------

### Fangster den seneste måned

```{r}
plotOutput("plotCatchSalMonth")
```

```{r, context = "server"}
output$plotCatchSalMonth <- renderPlot({
  dat <- datCatchSal %>% 
    dplyr::filter(Date > now() - days(30)) %>% 
    select(Date, Place) %>% 
    arrange(desc(Date))

  ggplot(data = dat, aes(x = Date)) +
    geom_bar(aes(fill = Place), width = 0.75) + 
    geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", position = position_dodge(width = 1)) + #  vjust = -0.5
    scale_x_date(date_labels = "%e. %b", date_breaks = "1 day", limits = c(NA_Date_, date(now()))) + # now()+ddays(1)
    labs(fill = "") + xlab("Dato") + ylab("Antal fangster") + 
    theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
 })
```


Row
-----------------------------------------------------------------------

### Ugentlige fangster `r curYear`

```{r}
plotOutput("plotCatchSalWeek")
```

```{r, context = "server"}
output$plotCatchSalWeek <- renderPlot({
  dat <- datCatchSal %>% 
    dplyr::filter(Date > ymd(paste0(curYear,"-01-01"))) %>% 
    select(Week, Place)
  
  p <- ggplot(data = dat, aes(x = Week)) +
    geom_bar(aes(fill = Place)) + 
    geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", position = position_dodge(width = 1)) #  vjust = -0.5
  if (curYear == year(now())) p <- p + expand_limits(x = isoweek(now())) 
  p <- p +
    coord_cartesian(clip = 'off') +
    labs(fill = "") + xlab("Uge") + ylab("Antal fangster") + 
    theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
  p
})
```

### Månedlige fangster `r curYear`

```{r}
plotOutput("plotCatchSalMonthNow")
```

```{r, context = "server"}
output$plotCatchSalMonthNow <-  renderPlot({
  dat <- datCatchSal %>% 
    dplyr::filter(Date > ymd(paste0(curYear,"-01-01"))) %>% 
    select(Month, Place)
  
  p <- ggplot(dat, aes(x = Month)) + 
    geom_bar(aes(fill = Place)) + 
    geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", position = position_dodge(width = 1)) # vjust = -.5 
  if (curYear == year(now())) p <- p + expand_limits(x = isoweek(now())) 
  p <- p +
    coord_cartesian(clip = 'off') +
    labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
    theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
  p
})
```

Row
-----------------------------------------------------------------------

### Opsumering

```{r, context = "data"}
cNames <- c(paste0(faIcon("calendar-alt", class = "far", title = "Måned")), 
   "<i class=\"fas\" title=\"Total antal\">&#x3A3;</i>",
   paste0(faIcon("mars", title = "Han"),"/",
          faIcon("venus", title = "Hun"), "/",
          faIcon("question", title = "Ukendt"), " (%)"),
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Flue'>F</span>/<span title='Spin'>S</span>/<span title='Orm'>O</span>/<span title='Andet'>A</span> (%)",
   paste0(faIcon("sync", title = "C&R"),"/",
          faIcon("times", title = "Hjemtaget"), " (%)"),
   paste0(faIcon("ruler-horizontal", title="Gens længde"), "/",
          faIcon("ruler", title="Max længde")),
   paste0(faIcon("balance-scale", title="Gens. vægt"), "/",
          faIcon("weight-hanging", title="Max vægt"),
          "/<i class=\"fas\" title=\"Total vægt\">&#x3A3;</i>"),
   paste0(faIcon("heart", title="Gens kondition"), "/",
          faIcon("gratipay", title="Max kondition"))
   ) 

datStatMonthSal %>%
  kable(col.names = cNames, escape = F, align = "c") %>%
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```






Fangsttabel {data-navmenu="Laks"}
=======================================================================

Row
-----------------------------------------------------------------------

### Seneste fangster

```{r}
dataTableOutput("dTSalCatch")
```

```{r, context = "server"}
output$dTSalCatch <- DT::renderDataTable(
  DT::datatable(
    datCatchSal %>% select(Date:Method, Fulton, Misc, NoWeight),
    class = 'stripe row-border order-column nowrap compact', # nowrap display compact
    rownames = FALSE,
    filter = 'bottom',
    escape = FALSE,
    options = list(pageLength = 15, order = list(list(0, 'desc')),
                   list(visible=FALSE, targets="NoWeight"),
                   # autoWidth = TRUE,
                   columnDefs = list(
                     list(className = 'dt-center', targets = 0:7),
                     list(visible=FALSE, targets=c(8))
                   )
              ),
    colnames = c('Dato', 'Længde', 'Vægt', 'Navn', 'Sted', 'Metode', 'Kondition', 'Diverse', 'NoWeight'),
    extensions = c('Responsive')  #,'FixedHeader','RowGroup'
  ) %>%
  formatStyle(columns = 'Weight', valueColumns = 'NoWeight', color = styleEqual(c(0, 1), c("black","green"))) %>%
  formatDate('Date', 'toLocaleDateString', params = list('da-DK')) %>%
  formatRound(c('Length'), digits = 0) %>%
  formatRound(c('Weight'), digits = 1) %>%
  formatRound(c('Fulton'), digits = 2)
)
```


Fangster `r curYear` {data-navmenu="Havørred"}
=======================================================================

Row
-----------------------------------------------------------------------

### Fangster i dag {.value-box}

```{r}
valueBoxOutput("cSeaToday")
```

```{r, context = "server", include=FALSE}
output$cSeaToday <- renderValueBox({
  valueBox(
    value = datCatchSea %>% dplyr::filter(Date == date(now())) %>% nrow(),
    icon = "fa-chart-line",
    color = "primary"
  )
})
```

### Fangster seneste syv dage {.value-box}

```{r}
valueBoxOutput("cSeaSeven")
```

```{r, context = "server", include=FALSE}
output$cSeaSeven <- renderValueBox({
  valueBox(
    value = datCatchSea %>% dplyr::filter(Date > now() - days(7)) %>% nrow(),
    icon = "fa-chart-line",
    color = "primary"
  )
})
```

### Fangster i `r curYear` (hjemtaget/genudsat) {.value-box}

```{r}
valueBoxOutput("cSeaYear")
```

```{r, context = "server"}
output$cSeaYear <- renderValueBox({
  total <- datCatchSea %>% dplyr::filter(year(Date) == curYear) %>% nrow()
  killed <- datCatchSea %>% dplyr::filter(year(Date) == curYear, Killed == TRUE) %>% nrow()
  killedPct <- if_else(total > 0, format(100*killed/total, digits = 0), "0")
  releasedPct <- if_else(total > 0, format(100*(total - killed)/total, digits = 0), "0")
  valueBox(
    value = str_c(total, " (", killedPct, "%/", releasedPct, "%)"),
    icon = "fa-fish",
    color = "warning"
  )
})
```

### Største fisk `r curYear` {.value-box}

```{r}
valueBoxOutput("cSeaBig")
```

```{r, context = "server"}
output$cSeaBig <- renderValueBox({
  ct <- datCatchSea %>% dplyr::filter(year(Date) == curYear) %>% 
    dplyr::filter(Weight == max(Weight, na.rm = T)) %>% arrange(Weight, Length)
  val <- if_else(nrow(ct) > 0, paste(ct$Weight[1], "kg og", ct$Length[1], "cm"), "-")
  cap <- if_else(nrow(ct) > 0,paste("Største fisk i", curYear, "fanget af", ct$Name[1]), paste("Største fisk", curYear))  
  valueBox(
    caption = cap,
    value = val,
    icon = "fa-trophy",
    color = "success"
  )
})
```


Row
-----------------------------------------------------------------------

### Fangster den seneste måned

```{r}
plotOutput("plotCatchSeaMonth")
```

```{r, context = "server"}
output$plotCatchSeaMonth <- renderPlot({
  dat <- datCatchSea %>% 
    dplyr::filter(Date > now() - days(30)) %>% 
    select(Date, Place) %>% 
    arrange(desc(Date))

  ggplot(data = dat, aes(x = Date)) +
    geom_bar(aes(fill = Place)) + 
    geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", position = position_dodge(width = 1)) +
    scale_x_date(date_labels = "%e. %b", date_breaks = "1 day", limits = c(NA_Date_, date(now()+ddays(1)))) + 
    labs(fill = "") + xlab("Dato") + ylab("Antal fangster") + 
    theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
 })
```


Row
-----------------------------------------------------------------------

### Ugentlige fangster `r curYear`

```{r}
plotOutput("plotCatchSeaWeek")
```

```{r, context = "server"}
output$plotCatchSeaWeek <- renderPlot({
  dat <- datCatchSea %>% 
    dplyr::filter(Date > ymd(paste0(curYear,"-01-01"))) %>% 
    select(Week, Place)
  
  ggplot(data = dat, aes(x = Week)) +
    geom_bar(aes(fill = Place)) + 
    geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", position = position_dodge(width = 1)) +
    expand_limits(x = isoweek(now())) + 
    labs(fill = "") + xlab("Uge") + ylab("Antal fangster") + 
    theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
})
```

### Månedlige fangster `r curYear`

```{r}
plotOutput("plotCatchSeaMonthNow")
```

```{r, context = "server"}
output$plotCatchSeaMonthNow <- renderPlot({
  dat <- datCatchSea %>% 
    dplyr::filter(Date > ymd(paste0(curYear,"-01-01"))) %>% 
    select(Month, Place)
  
ggplot(dat, aes(x = Month)) + 
     geom_bar(aes(fill = Place), stat="count") +
     geom_text(aes(label = ..count.., y= ..count.. ), stat= "count", position = position_dodge(width = 1)) +
     #expand_limits(x = month(now(), label = T)) + 
     labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
     theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
})
```

Row
-----------------------------------------------------------------------

### Opsumering

```{r, context = "data"}
cNames <- c(paste0(faIcon("calendar-alt", class = "far", title = "Måned")), 
   "<i class=\"fas\" title=\"Total antal\">&#x3A3;</i>",
   paste0(faIcon("mars", title = "Han"),"/",
          faIcon("venus", title = "Hun"), "/",
          faIcon("question", title = "Ukendt"), " (%)"),
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Flue'>F</span>/<span title='Spin'>S</span>/<span title='Orm'>O</span>/<span title='Andet'>A</span> (%)",
   paste0(faIcon("sync", title = "C&R"),"/",
          faIcon("times", title = "Hjemtaget"), " (%)"),
   paste0(faIcon("ruler-horizontal", title="Gens længde"), "/",
          faIcon("ruler", title="Max længde")),
   paste0(faIcon("balance-scale", title="Gens. vægt"), "/",
          faIcon("weight-hanging", title="Max vægt"),
          "/<i class=\"fas\" title=\"Total vægt\">&#x3A3;</i>"),
   paste0(faIcon("heart", title="Gens kondition"), "/",
          faIcon("gratipay", title="Max kondition"))
   ) 

datStatMonthSea %>%
  kable(col.names = cNames, escape = F, align = "c") %>%
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```



Fangsttabel {data-navmenu="Havørred"}
=======================================================================

Row
-----------------------------------------------------------------------

### Seneste fangster

```{r}
dataTableOutput("dTSeaCatch")
```

```{r, context = "server"}
output$dTSeaCatch <- DT::renderDataTable(
  DT::datatable(
    datCatchSea %>% select(Date:Method, Fulton, Misc, NoWeight),
    class = 'stripe row-border order-column nowrap compact', # nowrap display compact
    rownames = FALSE,
    filter = 'bottom',
    escape = FALSE,
    options = list(pageLength = 15, order = list(list(0, 'desc')),
                   list(visible=FALSE, targets="NoWeight"),
                   # autoWidth = TRUE,
                   columnDefs = list(
                     list(className = 'dt-center', targets = 0:7),
                     list(visible=FALSE, targets=c(8))
                   )
              ),
    colnames = c('Dato', 'Længde', 'Vægt', 'Navn', 'Sted', 'Metode', 'Kondition', 'Diverse', 'NoWeight'),
    extensions = c('Responsive')  #,'FixedHeader','RowGroup'
  ) %>%
  formatStyle(columns = 'Weight', valueColumns = 'NoWeight', color = styleEqual(c(0, 1), c("black","green"))) %>%
  formatDate('Date', 'toLocaleDateString', params = list('da-DK')) %>%
  formatRound(c('Length'), digits = 0) %>%
  formatRound(c('Weight'), digits = 1) %>%
  formatRound(c('Fulton'), digits = 2)
)
```




Vandstand 
=======================================================================

Row {data-height=800}
-----------------------------------------------------------------------

### Vandstand 
```{r}
plotlyOutput("plotWLevelPresent")
```

```{r, context = "server"}
# input <- NULL
# input$iScaleW <- "LevelRelative"
# input$iPlaceW <- "Skjern Å - Sandfeldvej (055414)"

output$plotWLevelPresent <- renderPlotly({
  loc <- Sys.setlocale("LC_TIME", "da_DK")
  on.exit(Sys.setlocale("LC_TIME", loc))
  yLab <- if_else(input$iScaleW == "LevelRelative", "Relativ vandstand (cm)", "Vandstand (cm)")
  tmp <- datWLevel %>% 
      filter(Place == input$iPlaceW) %>% 
      transmute(Dato = Date, Vandstand = .data[[input$iScaleW]], Year = YGroup, Size = if_else(Year == year(now()), 2, 1))
  p <- ggplot(
    data = tmp, 
    aes(x = Dato, y = Vandstand, color = Year, size = Size, group = 1,   # group = 1,  must be added for working https://stackoverflow.com/questions/45948926/ggplotly-text-aesthetic-causing-geom-line-to-not-display
        text = str_c("Dato: ", format(Dato, "%e. %b %H:00"), '<br>Vandstand: ', Vandstand, ' cm'))) 
    # geom_smooth(aes(group = Group), na.rm = T, method = lm, formula = y ~ splines::bs(x, 40), 
    #             se = FALSE, color = "grey", lwd=0.5) +
  
  if (input$iScaleW == "LevelRelative") p <- p + geom_hline(yintercept = 0, colour="black")
  p <- p +
    geom_line(na.rm = T) + 
    geom_text(data = tmp %>% group_by(Year) %>% filter(Dato == max(Dato)), 
              aes(label = Year, x = max(.data$Dato) + hours(12), y = Vandstand, color = Year), 
              size = 3, hjust = "left") + 
    ylab(yLab) + xlab("Dato") +
    theme(axis.text.x  = element_text(angle=90, hjust = 1, vjust = 1), legend.position="none") + 
    scale_x_datetime(date_labels = "%e. %b", date_breaks = "1 day") + #, limits = c(min(tmp$Dato), max(tmp$Dato) + hours(18))) +
    scale_size_continuous(range = c(0.25, 1))
  ggplotly(p, tooltip = c("text"))
})
```

Row {data-height=200}
-----------------------------------------------------------------------

###
```{r}
cIPlaceWUnit <- unique(datWLevel$Place)
selectInput("iPlaceW", "Sted:", cIPlaceWUnit, selected = cIPlaceWUnit[5], selectize = FALSE)
```

```{r}
cIScaleWUnit <- c("Relativ" = "LevelRelative", "Absolut" = "Level")
selectInput("iScaleW", "Vælg enhed på y-aksen:", cIScaleWUnit, selectize = FALSE)
```


Statistik over år {data-navmenu="Laks"}
=======================================================================

Row
-----------------------------------------------------------------------

### Statistik over år

```{r, context = "data"}
cNames <- c(paste0(faIcon("calendar-alt", class = "far", title = "Måned")), 
   "<i class=\"fas\" title=\"Total antal\">&#x3A3;</i>",
   paste0(faIcon("mars", title = "Han"),"/",
          faIcon("venus", title = "Hun"), "/",
          faIcon("question", title = "Ukendt"), " (%)"),
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Flue'>F</span>/<span title='Spin'>S</span>/<span title='Orm'>O</span>/<span title='Andet'>A</span> (%)",
   paste0(faIcon("sync", title = "C&R"),"/",
          faIcon("times", title = "Hjemtaget"), " (%)"),
   paste0(faIcon("ruler-horizontal", title="Gens længde"), "/",
          faIcon("ruler", title="Max længde")),
   paste0(faIcon("balance-scale", title="Gens. vægt"), "/",
          faIcon("weight-hanging", title="Max vægt"),
          "/<i class=\"fas\" title=\"Total vægt\">&#x3A3;</i>"),
   paste0(faIcon("heart", title="Gens kondition"), "/",
          faIcon("gratipay", title="Max kondition"))
   ) 

datStatYearSal %>% 
  kable(col.names = cNames, escape = F, align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))

# tabStat <- 
#   datStatYearSal %>% 
#   transmute(Year, Total, 
#          Sex = paste0(format(100*Male/Total, digits = 0, trim = TRUE), "/", 
#                       format(100*Female/Total, digits = 0, trim = TRUE), "/", 
#                       format(100*SexUnknown/Total, digits = 0, trim = TRUE)), 
#          Place = paste0(format(100*Lower/Total, digits = 0, trim = TRUE), "/", 
#                         format(100*Middle/Total, digits = 0, trim = TRUE), "/", 
#                         format(100*Upper/Total, digits = 0, trim = TRUE), "/", 
#                         format(100*Haderis/Total, digits = 0, trim = TRUE)),
#          Released = paste0(round(100*Released/Total, 0), "/", 
#                            round(100*Killed/Total, 0), "/", 
#                            round(100*KilledUnknown/Total, 0)),
#          LengthAvg = round(LengthAvg,0), 
#          LengthMax = round(LengthMax,0), 
#          WeightAvg = round(WeightAvg,1), 
#          WeightMax = round(WeightMax,1), 
#          Kg = round(Kg,0), 
#          FultonAvg = round(FultonAvg,2)) %>% 
#   arrange(desc(Year))
# # names(tabStat) <- c("År", "Total", "Hun/Han/? (%)", "N/M/Ø/H (%)", "C&R (%)", "Hjemtaget (%)", "Gens. længde", "Max længde", "Gens. vægt", "Max vægt", "Total Kg", "Gens. Kondition")
# 
# # renderDT(
#   DT::datatable(
#     tabStat,
#     colnames = c("År", "Total", 
#                  "<img src='www/boy.gif' alt='Han'>/<img src='www/girl.gif' alt='Han'>/? (%)", 
#                  "N/M/Ø/H (%)", 
#                  "<img src='www/c_and_r.gif' alt='C&R'>/K (%)", 
#                  "Gens. længde", 
#                  "Max længde", "Gens. vægt", "Max vægt", "Total Kg", "Gens. Kondition"),
#     class = 'nowrap display', # nowrap display compact stripe row-border order-column
#     rownames = FALSE,
#     escape = FALSE,
#     fillContainer = TRUE,
#     selection = "none",
#     options = list(#autoWidth = TRUE,
#       paging = FALSE, bSort = FALSE, dom = 'tip' #scrollX = TRUE, scrollY = TRUE, scrollCollapse=TRUE
#       # columnDefs = list(list(className = 'dt-center', targets = 2:7))
#               ),
#     extensions = c('Responsive')
#   )
# )
```




Row
-----------------------------------------------------------------------

### Månedlige fangster givet sted 2004-`r year(now())`

```{r}
plotOutput("plotCatchSalMonthlyP")
```

```{r, context = "server"}
output$plotCatchSalMonthlyP <- renderPlot({
  dat <- datCatchSal %>% select(Month, Place)
  
  ggplot(data = dat, aes(x = Month)) +
    geom_bar(aes(fill = Place, y = (..count..)/sum(..count..))) + 
    geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),2)),
                   y = (..count..)/sum(..count..)), stat= "count", vjust = -.5) +
    labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
    scale_y_continuous(labels = scales::percent) + 
    guides(fill = guide_legend(ncol = 6)) + 
    theme(legend.position="bottom")  # axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), 
})
```

### Månedlige fangster givet metode 2004-`r year(now())`

```{r}
plotOutput("plotCatchSalMonthlyM")
```

```{r, context = "server"}
output$plotCatchSalMonthlyM <- renderPlot({
  dat <- datCatchSal %>% select(Month, Method)
  
  ggplot(data = dat, aes(x = Month)) +
    geom_bar(aes(fill = Method, y = (..count..)/sum(..count..))) + 
    geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),2)),
                   y = (..count..)/sum(..count..)), stat= "count", vjust = -.5) +
    labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
    scale_y_continuous(labels = scales::percent) + 
    guides(fill = guide_legend(ncol = 4)) + 
    theme(legend.position="bottom")  # axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), 
})
```




Statistik over år {data-navmenu="Havørred"}
=======================================================================

Row
-----------------------------------------------------------------------

### Statistik over år

```{r, context = "data"}
cNames <- c(paste0(faIcon("calendar-alt", class = "far", title = "Måned")), 
   "<i class=\"fas\" title=\"Total antal\">&#x3A3;</i>",
   paste0(faIcon("mars", title = "Han"),"/",
          faIcon("venus", title = "Hun"), "/",
          faIcon("question", title = "Ukendt"), " (%)"),
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Nedre'>N</span>/<span title='Mellem'>M</span>/<span title='Øvre'>Ø</span>/<span title='Vorgod Å'>V</span>/<span title='Omme Å'>O</span>/<span title='Andet'>A</span> (%)",
   "<span title='Flue'>F</span>/<span title='Spin'>S</span>/<span title='Orm'>O</span>/<span title='Andet'>A</span> (%)",
   paste0(faIcon("sync", title = "C&R"),"/",
          faIcon("times", title = "Hjemtaget"), " (%)"),
   paste0(faIcon("ruler-horizontal", title="Gens længde"), "/",
          faIcon("ruler", title="Max længde")),
   paste0(faIcon("balance-scale", title="Gens. vægt"), "/",
          faIcon("weight-hanging", title="Max vægt"),
          "/<i class=\"fas\" title=\"Total vægt\">&#x3A3;</i>"),
   paste0(faIcon("heart", title="Gens kondition"), "/",
          faIcon("gratipay", title="Max kondition"))
   ) 

datStatYearSea %>% 
  kable(col.names = cNames, escape = F, align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```




Row
-----------------------------------------------------------------------

### Månedlige fangster givet sted 2004-`r year(now())`

```{r}
plotOutput("plotCatchSeaMonthlyP")
```

```{r, context = "server"}
output$plotCatchSeaMonthlyP <- renderPlot({
  dat <- datCatchSea %>% select(Month, Place)
  
  ggplot(data = dat, aes(x = Month)) +
    geom_bar(aes(fill = Place, y = (..count..)/sum(..count..))) + 
    geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),2)),
                   y = (..count..)/sum(..count..)), stat= "count", vjust = -.5) +
    labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
    scale_y_continuous(labels = scales::percent) + 
    guides(fill = guide_legend(ncol = 6)) + 
    theme(legend.position="bottom")  # axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), 
})
```

### Månedlige fangster givet metode 2004-`r year(now())`

```{r}
plotOutput("plotCatchSeaMonthlyM")
```

```{r, context = "server"}
output$plotCatchSeaMonthlyM <- renderPlot({
  dat <- datCatchSea %>% select(Month, Method)
  
  ggplot(data = dat, aes(x = Month)) +
    geom_bar(aes(fill = Method, y = (..count..)/sum(..count..))) + 
    geom_text(aes(label = scales::percent(round((..count..)/sum(..count..),2)),
                   y = (..count..)/sum(..count..)), stat= "count", vjust = -.5) +
    labs(fill = "") + xlab("Måned") + ylab("Antal fangster") + 
    scale_y_continuous(labels = scales::percent) + 
    guides(fill = guide_legend(ncol = 4)) + 
    theme(legend.position="bottom")  # axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), 
})
```




Sammenlign {data-navmenu="Laks" #compare-sal}
=======================================================================

Row {data-height=1000}
-----------------------------------------------------------------------

### Sammenligning

```{r}
plotOutput("plotCompareSal")
```

```{r, context = "server"}
output$plotCompareSal <- renderPlot({
# input <- NULL
# input$iInvYear <- c(2018,2019)
# input$iInvDay <- c("2019-04-16", "2019-04-25")
# input$iXUnit <- "Day"  # Day
# input$iYUnit <- "yVAvgW"
# input$iGroup <- "None"
# input$iData <- "TRUE"

qString <- list(iInvYearSal = input$iInvYearSal,
                iInvDaySal = input$iInvDaySal,
                iXUnitSal = input$iXUnitSal,
                iYUnitSal = input$iYUnitSal,
                iDataSal = input$iDataSal,
                iGroupSal = input$iGroupSal)
query <- getQueryString()
qString <- mergeLists(qString, query)
# updateSelectInput(session, "iXUnitSal",
#  selected = qString$iXUnitSal
# )

qS <- URLencode(str_c("?", str_c(names(qString), qString, sep = "=", collapse="&"), "#section-compare-sal"))
updateQueryString(qS, mode = "push")

if (input$iXUnitSal == "Day") {
  iXUnitSal <- "DayStr" 
} else if (input$iXUnitSal == "Year") {
  iXUnitSal <- "None"
} else iXUnitSal <- input$iXUnitSal

dat <- 
  datCatchSal %>% 
  dplyr::filter(Year >= input$iInvYearSal[1], Year <= input$iInvYearSal[2],
                Day >= yday(ymd(str_c(input$iInvYearSal[1],"-",month(input$iInvDaySal[1]),"-",day(input$iInvDaySal[1])))),
                Day <= yday(ymd(str_c(input$iInvYearSal[2],"-",month(input$iInvDaySal[2]),"-",day(input$iInvDaySal[2]))))) 
if (input$iDataSal == "KilledTrue") dat <- dat %>% dplyr::filter(Killed)
if (input$iDataSal == "KilledFalse") dat <- dat %>% dplyr::filter(!Killed)
if (input$iDataSal == "WeightTrue") dat <- dat %>% dplyr::filter(NoWeight == 0)
dat <- dat %>% 
  mutate(None = "", xV = str_c(.data[[iXUnitSal]], " ", Year), grp = .data[[input$iGroupSal]]) %>% 
  group_by_at(c("xV", "grp", input$iXUnitSal)) %>%
  summarise(yVTotal = n(),
            yVMaxW = max(Weight, na.rm = T), 
            yVMaxL = max(Length, na.rm = T),
            yVAvgW = round(mean(Weight, na.rm = T),1), 
            yVAvgL = round(mean(Length, na.rm = T),0),
            yVTotalW = round(sum(Weight, na.rm = T),0)
            ) %>% 
  mutate(yV = .data[[input$iYUnitSal]]) %>% 
  arrange_at(c(input$iXUnitSal, "xV")) %>% 
  group_by(xV) %>% 
  mutate(pct = sum(yVTotal)) %>% 
  group_by_at(c("xV", "grp", input$iXUnitSal)) %>% 
  mutate(label = str_c(round(100*yVTotal/pct, 0), "%"))

if (input$iGroupSal == "None") dat <- dat %>% mutate(label = yV)
xLab <- names(cIXUnit)[grep(input$iXUnitSal, cIXUnit)]
yLab <- names(cIYUnit)[grep(input$iYUnitSal, cIYUnit)]
dat$xV <- factor(dat$xV, levels = unique(dat$xV[order(dat[[input$iXUnitSal]], dat$xV)]))
ggplot(data = dat, aes(x = xV, y = yV)) +
  geom_col(aes(fill = grp), position = position_dodge2(preserve = "single")) +
  # geom_text(aes(label = yV, y = 1.05*yV), position = position_dodge2(width = 0.9)) + 
  geom_text(aes(label = label, y = 1.05*yV), position = position_dodge2(width = 0.9), cex = 3)  +  #, vjust = "inward", hjust = "inward"
  labs(fill = "") + xlab(xLab) + ylab(yLab) +
  theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
})
```

Row {data-height=250}
-----------------------------------------------------------------------

### 
```{r}
sliderInput("iInvYearSal", label = "Vælg årstal:",
            min = 2004, max = year(now()), sep = "",
            value = c(2016, year(now())), step = 1)
sliderInput("iInvDaySal", label = "Vælg dato interval: ",
            min = as.Date("2019-04-01"), max = as.Date("2019-10-31"), 
            value = c(as.Date("2019-04-01"), as.Date("2019-10-31")), step = 1,
            timeFormat = "%d %b")
```

### 
```{r}
cIXUnit <- c("Dag" = "Day", "Uge" = "Week", "Måned" = "Month", "År" = "Year")
selectInput("iXUnitSal", "Vælg enhed på x-aksen:", cIXUnit, selected = "Year", selectize = FALSE)
cIYUnit <- c("Fisk fanget" = "yVTotal",
             "Gennemsnitlig vægt" = "yVAvgW",
             "Gennemsnitlig længde" = "yVAvgL",
             "Max vægt" = "yVMaxW",
             "Max længde" = "yVMaxL",
             "Total vægt" = "yVTotalW")
selectInput("iYUnitSal", "Vælg enhed på y-aksen:", cIYUnit, selectize = FALSE)
```

### 
```{r}
cIData <- c("Alle fangster" = "All",
            "Hjemtagne fisk" = "KilledTrue",
            "Genudsatte fisk" = "KilledFalse",
            "Fangster med vægt angivelse" = "WeightTrue")
selectInput("iDataSal", "Vælg datasæt:", cIData, "All", selectize = FALSE)
cIGroup <- c("Område" = "Place",
            "Metode" = "Method",
            "Køn" = "Sex",
            "Hjemtaget" = "Killed",
            "Ingen" = "None")
selectInput("iGroupSal", "Vælg gruppe inddeling:", cIGroup, "None", selectize = FALSE)
```




Sammenlign {data-navmenu="Havørred"}
=======================================================================

Row {data-height=1000}
-----------------------------------------------------------------------

### Sammenligning

```{r}
plotOutput("plotCompareSea")
```

```{r, context = "server"}
output$plotCompareSea <- renderPlot({
  
# input <- NULL
# input$iInvYear <- c(2018,2019)
# input$iInvDay <- c("2019-04-16", "2019-04-25")
# input$iXUnit <- "Day"  # Day
# input$iYUnit <- "yVAvgW"
# input$iGroup <- "None"
# input$iData <- "TRUE"

if (input$iXUnitSea == "Day") {
  iXUnitSea <- "DayStr" 
} else if (input$iXUnitSea == "Year") {
  iXUnitSea <- "None"
} else iXUnitSea <- input$iXUnitSea

dat <- 
  datCatchSea %>% 
  dplyr::filter(Year >= input$iInvYearSea[1], Year <= input$iInvYearSea[2],
                Day >= yday(ymd(str_c(input$iInvYearSea[1],"-",month(input$iInvDaySea[1]),"-",day(input$iInvDaySea[1])))),
                Day <= yday(ymd(str_c(input$iInvYearSea[2],"-",month(input$iInvDaySea[2]),"-",day(input$iInvDaySea[2]))))) 
if (input$iDataSea == "KilledTrue") dat <- dat %>% dplyr::filter(Killed)
if (input$iDataSea == "KilledFalse") dat <- dat %>% dplyr::filter(!Killed)
if (input$iDataSea == "WeightTrue") dat <- dat %>% dplyr::filter(NoWeight == 0)
dat <- dat %>% 
  mutate(None = "", xV = str_c(.data[[iXUnitSea]], " ", Year), grp = .data[[input$iGroupSea]]) %>% 
  group_by_at(c("xV", "grp", input$iXUnitSea)) %>%
  summarise(yVTotal = n(),
            yVMaxW = max(Weight, na.rm = T), 
            yVMaxL = max(Length, na.rm = T),
            yVAvgW = round(mean(Weight, na.rm = T),1), 
            yVAvgL = round(mean(Length, na.rm = T),0),
            yVTotalW = round(sum(Weight, na.rm = T),0)
            ) %>% 
  mutate(yV = .data[[input$iYUnitSea]]) %>% 
  arrange_at(c(input$iXUnitSea, "xV")) %>% 
  group_by(xV) %>% 
  mutate(pct = sum(yVTotal)) %>% 
  group_by_at(c("xV", "grp", input$iXUnitSea)) %>% 
  mutate(label = str_c(round(100*yVTotal/pct, 0), "%"))

if (input$iGroupSea == "None") dat <- dat %>% mutate(label = yV)
xLab <- names(cIXUnit)[grep(input$iXUnitSea, cIXUnit)]
yLab <- names(cIYUnit)[grep(input$iYUnitSea, cIYUnit)]
dat$xV <- factor(dat$xV, levels = unique(dat$xV[order(dat[[input$iXUnitSea]], dat$xV)]))
ggplot(data = dat, aes(x = xV, y = yV)) +
  geom_col(aes(fill = grp), position = position_dodge2(preserve = "single")) +
  # geom_text(aes(label = yV, y = 1.05*yV), position = position_dodge2(width = 0.9)) + 
  geom_text(aes(label = label, y = 1.05*yV), position = position_dodge2(width = 0.9), cex = 3)  +  #, vjust = "inward", hjust = "inward"
  labs(fill = "") + xlab(xLab) + ylab(yLab) +
  theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom")
})
```

Row {data-height=250}
-----------------------------------------------------------------------

### 
```{r}
sliderInput("iInvYearSea", label = "Vælg årstal:",
            min = 2004, max = year(now()), sep = "",
            value = c(2016, year(now())), step = 1)
sliderInput("iInvDaySea", label = "Vælg dato interval: ",
            min = as.Date("2019-04-01"), max = as.Date("2019-10-31"), 
            value = c(as.Date("2019-04-01"), as.Date("2019-10-31")), step = 1,
            timeFormat = "%d %b")
```

### 
```{r}
cIXUnit <- c("Dag" = "Day", "Uge" = "Week", "Måned" = "Month", "År" = "Year")
selectInput("iXUnitSea", "Vælg enhed på x-aksen:", cIXUnit, selected = "Year", selectize = FALSE)
cIYUnit <- c("Fisk fanget" = "yVTotal",
             "Gennemsnitlig vægt" = "yVAvgW",
             "Gennemsnitlig længde" = "yVAvgL",
             "Max vægt" = "yVMaxW",
             "Max længde" = "yVMaxL",
             "Total vægt" = "yVTotalW")
selectInput("iYUnitSea", "Vælg enhed på y-aksen:", cIYUnit, selectize = FALSE)
```

### 
```{r}
cIData <- c("Alle fangster" = "All",
            "Hjemtagne fisk" = "KilledTrue",
            "Genudsatte fisk" = "KilledFalse",
            "Fangster med vægt angivelse" = "WeightTrue")
selectInput("iDataSea", "Vælg datasæt:", cIData, "All", selectize = FALSE)
cIGroup <- c("Område" = "Place",
            "Metode" = "Method",
            "Køn" = "Sex",
            "Hjemtaget" = "Killed",
            "Ingen" = "None")
selectInput("iGroupSea", "Vælg gruppe inddeling:", cIGroup, "None", selectize = FALSE)
```




Estimat af vægt {data-navmenu="Laks"}
=======================================================================
  
Row
-----------------------------------------------------------------------
  
### Estimat af vægt (kg) givet længde (cm) og måned
  
```{r}
tab <- 
  datWeightSal %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Avg) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab1 <- 
  datWeightSal %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Lower) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, " [", .y))

tab1 <- datWeightSal %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Upper) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, ",", .y, "]")) %>% 
  mutate(Length = str_remove(Length, " .*")) %>% 
  select(Length, ncol(.):2) 
  
monthNames <- c("Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
colnames(tab) <- c("Længde", monthNames[4:(ncol(tab) + 2)])

tab %>% 
  kable(align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Row
-----------------------------------------------------------------------

### Plot af vægt givet længde

```{r}
plotlyOutput("plotWeightSal")
```

```{r, context = "server"}
output$plotWeightSal <- renderPlotly({
  ggplot(datWeightSal, aes(x = Length, y = Avg)) +
    geom_line(aes(color = Period)) +
    labs(title = "", color = "") +
    ylab("Vægt (kg)") + xlab("Længde (cm)") +
    guides(col = guide_legend(ncol = 7)) +
    theme(legend.position="bottom")
    # scale_color_brewer(palette = "Set1") +
    # scale_color_discrete(name = "", labels = c("Sep-Okt", "Marts", "Apr-Aug"))
})
```



Estimat af vægt {data-navmenu="Havørred"}
=======================================================================
  
Row
-----------------------------------------------------------------------
  
### Estimat af vægt (kg) givet længde (cm) og måned
  
```{r}
tab <- 
  datWeightSea %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Avg) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab1 <- 
  datWeightSea %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Lower) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, " [", .y))

tab1 <- datWeightSea %>%
  pivot_wider(id_cols = Length:Period, names_from = Period, values_from = Upper) %>% 
  mutate_at(2:ncol(.), function(x) {
    format(round(x, 1), 1)
  })

tab <- map2_df(tab, tab1, ~ str_c(.x, ",", .y, "]")) %>% 
  mutate(Length = str_remove(Length, " .*")) %>% 
  select(Length, ncol(.):2) 
  
monthNames <- c("Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
colnames(tab) <- c("Længde", monthNames[4:(ncol(tab) + 2)])

tab %>% 
  kable(align = "c") %>% 
  kable_styling(fixed_thead = T, font_size = 10,
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Row
-----------------------------------------------------------------------

### Plot af vægt givet længde

```{r}
plotlyOutput("plotWeightSea")
```

```{r, context = "server"}
output$plotWeightSea <- renderPlotly({
  ggplot(datWeightSea, aes(x = Length, y = Avg)) +
    geom_line(aes(color = Period)) +
    labs(title = "", color = "") +
    ylab("Vægt (kg)") + xlab("Længde (cm)") +
    guides(col = guide_legend(ncol = 7)) +
    theme(legend.position="bottom")
    # scale_color_brewer(palette = "Set1") +
    # scale_color_discrete(name = "", labels = c("Sep-Okt", "Marts", "Apr-Aug"))
})
```




Slusen
=======================================================================

Row
-----------------------------------------------------------------------

### Åben de seneste 7 dage {.value-box}

```{r}
rate <- datFlow %>% 
  dplyr::filter(DateTime > now() - days(7)) %>% 
  # summarise(Rate = 100*sum(Open)/(2*n())) %>% 
  summarise(Rate = 100*sum(Open>0)/(n())) %>% 
  as.numeric() %>% round(0)
gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(75, 100), warning = c(25, 75), danger = c(0, 25)
))
```

### Åben de seneste 14 dage {.value-box}

```{r}
rate <- datFlow %>% 
  # summarise(Rate = 100*sum(Open)/(2*n())) %>% 
  summarise(Rate = 100*sum(Open>0)/(n())) %>% 
  as.numeric() %>% round(0)
gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(75, 100), warning = c(25, 75), danger = c(0, 25)
))
```

Row
-----------------------------------------------------------------------

### Sluse flow de seneste 14 dage (strøm ind i fjorden er positiv)

```{r}
plotlyOutput("plotLock")
```

```{r, context = "server"}
output$plotLock <- renderPlotly({
  p <- ggplot(datFlow) + 
    # geom_bar(aes(x = DateTime, y = 100*Open), stat = "identity") +
    geom_hline(yintercept = 0, size = 0.25) + 
    geom_line(aes(x = DateTime, y = Flow), color = "#3399ff") + #, colour = Open
    # scale_colour_gradient2(low = "red", mid = "yellow", high = "green", na.value = NA, midpoint = 1, guide = "legend") +
    # geom_point(aes(x = DateTime, y = Flow), data = dat[findPeaks(dat$Flow),]) +
    #scale_colour_gradient(low = "red", high = "green", na.value = NA, guide = "legend", breaks = c(0,1,2), name = "", labels = c("Lukket", "Delvis åben", "Åben")) +
    # guide_coloursteps(even.steps = TRUE, show.limits = NULL, ticks = FALSE) +
    theme(axis.text.x  = element_text(angle=90, hjust = 1, vjust = 1), legend.position="none") + 
    scale_x_datetime(date_labels = "%e. %b", date_breaks = "1 day") +
    labs(x = "Dato", y = "Flow (m3/s, udstrøm er negativ)")  #title = "Sluseflow Hvide Sande"
  ggplotly(p)
})
```


Kort
=======================================================================

```{r}
leafletOutput("maplet")
```


```{r, context = "server"}
output$maplet <- renderLeaflet({
  maplet
})
```


Vejret
=======================================================================

Row
-----------------------------------------------------------------------

### Vejret

Vejrkort

* [Windfinder nedre](https://www.windfinder.com/#13/55.9251/8.4928/sfc){target="_blank"}
* [Windfinder mellem](https://www.windfinder.com/#13/55.9376/8.6507/sfc){target="_blank"}
* [Windfinder øvre](https://www.windfinder.com/#13/55.9652/8.8720/sfc){target="_blank"}
* [Windy](https://www.windy.com/55.959/8.645?55.925,8.545,13){target="_blank"}

Lokale vejrudsigter

* [Yr Arnborg](https://www.yr.no/sted/Danmark/Midtjylland/Arnborg/){target="_blank"}
* [DMI Arnborg](https://www.dmi.dk/lokation/show/DK/2624622/Arnborg/){target="_blank"}
* [Yr Sdr. Felding](https://www.yr.no/sted/Danmark/Midtjylland/S%C3%B8nder_Felding/){target="_blank"}
* [DMI Sdr. Felding](https://www.dmi.dk/lokation/show/DK/2613064/S%C3%B8nder_Felding/){target="_blank"}
* [Yr Borris](https://www.yr.no/sted/Danmark/Midtjylland/Borris/){target="_blank"}
* [DMI Borris](https://www.dmi.dk/lokation/show/DK/2623640/Borris/){target="_blank"}
* [Yr Skjern](https://www.yr.no/sted/Danmark/Midtjylland/Skjern/){target="_blank"}
* [DMI Skjern](https://www.dmi.dk/lokation/show/DK/2613715/Skjern/){target="_blank"}

Om siden 
=======================================================================

Row
-----------------------------------------------------------------------

### Info

Dette dashboard er lavet af Lars Relund og giver information omkring fiskeriet i Skjern Å. Data er hentet fra forskellige kilder. 

Fangst data er fra [SÅS](https://skjernaasam.dk/catchreport/?species=salmon). Der er data fra 2004. Kun laks og havørred over mindstemålet vises under fangster. Å systemet er opdelt i zoner *Nedre* (fra udløbet of opstrøms til Borris Krog bro), *Mellem* (fra Borris Krog Bro til Tarp Bro), *Øvre* (Opstrøms Tarp Bro), *Vorgod Å*, *Omme Å* samt *Andet* (andre områder). Kondition er beregnet udfra [Fultons formel](http://ulnits.dk/biologi/the-k-factor/). Du kan sammenligne de forskellige år under både *Havørred* og *Laks* menuerne.

<!-- Vægten for genudsatte fisk er [estimeret](#estimat-af-vægt) udfra tidligere fangster og givet i en anden farve.  -->

<!-- For mere info se denne [rapport](http://htmlpreview.github.io/?https://github.com/relund/skjern/blob/master/reports/skjern_weight.html). -->

Vandstandsdata er fra [vandløbssiden](http://www.hydrometri.dk/hyd/). Den gennemensnitlige vandstand er estimeret som et rullende gennemsnit over 90 dage (45 dage på hver side af datoen) ved brug af tilgængelige data for alle år. Bemærk den gennemsnitlige vandstand siger nødvendigvis ikke noget om en god vandstand for fiskeriet, fx kan den gennemsnitlige vandstand i vinterhalvåret godt være høj.

Sluse data er fra [vejrstationen i Hvide Sande](http://hyde.dk/Sflow/default_flow.asp). Flowet er negativt ved strøm ud af fjorden (udstrøm) og positiv ved indstrøm. 

Kortet indeholder stednavne, parkering og kortoplysninger fra de forskellige foreninger ved åen. Ønsker du som forening at få tilføjet dit kort så er det nemt ([se her](https://github.com/relund/riverdata/tree/master/reports/map.md)).

Forslag til forbedringer kan sendes til lars.relund[at]gmail[dot]com.

Denne side drives på ikke kommerciel basis, men driften af siden koster penge (betaling for server). Ønsker du/I at støtte driften af siden og få vist dit logo herunder, så send en mail til lars.relund[at]gmail[dot]com.
  