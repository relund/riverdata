---
title: "Diverse statistik for laks i Skjern Å i 2022"
author: ''
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: true
    theme: united
    highlight: tango
    df_print: paged
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { 
      out_dir <- '../docs';
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=file.path(dirname(inputFile), out_dir, 'salmon-skjern.html')) })
---


```{r, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(kableExtra)
source("../shiny/skjern/functions.R")
prefix <- "https://raw.githubusercontent.com/relund/riverdata/master/data/"
curYear <- if_else(month(now())*100 + day(now()) < 416, year(now())-1, year(now()))   # assume previous year until season starts
datWeightSal <- read_csv(paste0(prefix, "data_skjern_weight_salmon.csv"), col_types = "dfddd")
datCatchSal <- readCatch(paste0(prefix, "data_skjern_catch_salmon"), datWeightSal) %>% filter(Year == 2022)
```

```{r}
cIXUnit <- c("Dag" = "Day", "Uge" = "Week", "Måned" = "Month", "År" = "Year", "Alle År" = "None")
cIYUnit <- c("Fisk fanget" = "yVTotal",
             "Gennemsnitlig vægt" = "yVAvgW",
             "Gennemsnitlig længde" = "yVAvgL",
             "Max vægt" = "yVMaxW",
             "Max længde" = "yVMaxL",
             "Total vægt" = "yVTotalW",
             "Procent (gruppeinddeling)" = "yVPct")
cIData <- c("Alle fangster" = "All",
            "Hjemtagne fisk" = "KilledTrue",
            "Genudsatte fisk" = "KilledFalse",
            "Fangster med vægt angivelse" = "WeightTrue")
cIGroup <- c("Område" = "Place",
            "Metode" = "Method",
            "Køn" = "Sex",
            "Hjemtaget" = "Killed",
            "Garnskadet" = "Net",
            "Ingen" = "None")
```

# Alle fangster

Der blev totalt fanget `r nrow(datCatchSal)` laks i 2022. 

Grupperet efter metode:

```{r}
dat1 <-datCatchSal %>% 
  count(Month, Method) %>% 
  pivot_wider(names_from = Method, values_from = n) %>% 
  rowwise(Month) %>%
  mutate(Totalt = sum(c_across(), na.rm = T)) 
dat2 <- dat1 %>% 
  ungroup() %>% 
  summarise(Month = "Totalt", across(2:ncol(.), ~ sum(.x, na.rm = T)))
dat <- bind_rows(dat1, dat2)

dat %>% 
  mutate(across(Spin:Totalt, ~ str_c(.x," (", round(100*.x/Totalt, 0), "%)"))) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Grupperet efter fedtfinneklippet:

```{r}
dat1 <- datCatchSal %>% 
  count(Month, Cut) %>% 
  pivot_wider(names_from = Cut, values_from = n) %>% 
  rowwise(Month) %>%
  mutate(Totalt = sum(c_across(), na.rm = T))
dat2 <- dat1 %>% 
  ungroup() %>% 
  summarise(Month = "Totalt", across(2:ncol(.), ~ sum(.x, na.rm = T)))
dat <- bind_rows(dat1, dat2)

dat %>% 
  mutate(across(1:(ncol(.)-1), ~ str_c(.x," (", round(100*.x/Totalt, 0), "%)"))) %>% 
  rename(Klippet = "TRUE", `Ikke klippet` = "FALSE", `Ved ikke` = "NA") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Grupperet efter små og store laks (73 cm):

```{r}
dat1 <- datCatchSal %>% 
  mutate(Gr = if_else(Length <= 73, "<=73cm", ">73cm")) %>% 
  count(Month, Gr) %>% 
  pivot_wider(names_from = Gr, values_from = n) %>% 
  rowwise(Month) %>%
  mutate(Totalt = sum(c_across(), na.rm = T)) 
dat2 <- dat1 %>% 
  ungroup() %>% 
  summarise(Month = "Totalt", across(2:ncol(.), ~ sum(.x, na.rm = T)))
dat <- bind_rows(dat1, dat2)

dat %>% 
  mutate(across(1:(ncol(.)-1), ~ str_c(.x," (", round(100*.x/Totalt, 0), "%)"))) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Antal fangster per fisker (antager at navne er unikke):

```{r}
dat <- datCatchSal %>% 
  count(Name) %>% 
  count(n) %>% 
  rename(`Antal laks` = "n", n = nn) %>% 
  mutate(Pct = round(100*n/sum(n), 0))

ggplot(data = dat, aes(x = `Antal laks`, y = Pct)) +
  geom_col() +
  geom_text(aes(label = Pct, y = Pct), cex = 4, nudge_y = 1)  
```

# Fangster uden fedtfinne

```{r}
datCatchSal <- datCatchSal %>% filter(Cut == TRUE)
```

Der blev totalt fanget `r nrow(datCatchSal)` laks i 2022. 

Grupperet efter metode:

```{r}
dat1 <-datCatchSal %>% 
  count(Month, Method) %>% 
  pivot_wider(names_from = Method, values_from = n) %>% 
  rowwise(Month) %>%
  mutate(Totalt = sum(c_across(), na.rm = T)) 
dat2 <- dat1 %>% 
  ungroup() %>% 
  summarise(Month = "Totalt", across(2:ncol(.), ~ sum(.x, na.rm = T)))
dat <- bind_rows(dat1, dat2)

dat %>% 
  mutate(across(Spin:Totalt, ~ str_c(.x," (", round(100*.x/Totalt, 0), "%)"))) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Grupperet efter små og store laks (73 cm):

```{r}
dat1 <- datCatchSal %>% 
  mutate(Gr = if_else(Length <= 73, "<=73cm", ">73cm")) %>% 
  count(Month, Gr) %>% 
  pivot_wider(names_from = Gr, values_from = n) %>% 
  rowwise(Month) %>%
  mutate(Totalt = sum(c_across(), na.rm = T)) 
dat2 <- dat1 %>% 
  ungroup() %>% 
  summarise(Month = "Totalt", across(2:ncol(.), ~ sum(.x, na.rm = T)))
dat <- bind_rows(dat1, dat2)

dat %>% 
  mutate(across(1:(ncol(.)-1), ~ str_c(.x," (", round(100*.x/Totalt, 0), "%)"))) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Antal fangster per fisker (antager at navne er unikke):

```{r}
dat <- datCatchSal %>% 
  count(Name) %>% 
  count(n) %>% 
  rename(`Antal laks` = "n", n = nn) %>% 
  mutate(Pct = round(100*n/sum(n), 0))

ggplot(data = dat, aes(x = `Antal laks`, y = Pct)) +
  geom_col() +
  geom_text(aes(label = Pct, y = Pct), cex = 4, nudge_y = 1)  
```

Hvor mange fiskere fanger en fedfinneklippet laks eller flere?

```{r}
dat <- datCatchSal %>% 
  group_by(Name) %>%
  summarize(n = n(), small = min(Length, na.rm = T) <= 73, big = max(Length, na.rm = T) > 73) %>% 
  ungroup() %>% 
  summarise(Personer = n(), "fangster<=73cm" = sum(small, na.rm =T ), "fangster>73cm" = sum(big, na.rm = T))
dat %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```





<!-- ```{r} -->
<!-- input <- NULL -->
<!-- input$iInvYearSal <- c(2022,2022) -->
<!-- input$iInvDaySal <- c("2022-04-01", "2022-10-31") -->
<!-- input$iXUnitSal <- "Year"   -->
<!-- input$iYUnitSal <- "yVTotal" -->
<!-- input$iGroupSal <- "Method" -->
<!-- input$iDataSal <- "All" -->

<!-- if (input$iXUnitSal == "Day") { -->
<!--   iXUnitSal <- "DayStr" -->
<!-- } else if (input$iXUnitSal == "Year") { -->
<!--   iXUnitSal <- "None" -->
<!-- } else if (input$iXUnitSal == "None") { -->
<!--   iXUnitSal <- "All" -->
<!-- } else iXUnitSal <- input$iXUnitSal -->

<!-- dat <-  -->
<!--   datCatchSal %>%  -->
<!--   # dplyr::filter(Year >= input$iInvYearSal[1], Year <= input$iInvYearSal[2], -->
<!--   #               MDay >= min(mday(input$iInvDaySal[1]), mday(input$iInvDaySal[2])), -->
<!--   #               MDay <= max(mday(input$iInvDaySal[1]), mday(input$iInvDaySal[2])), -->
<!--   #               MonthN >= month(input$iInvDaySal[1]), -->
<!--   #               MonthN <= month(input$iInvDaySal[2]))  -->
<!--   dplyr::filter(Year >= input$iInvYearSal[1], Year <= input$iInvYearSal[2], -->
<!--                 MonthN >= month(input$iInvDaySal[1]), -->
<!--                 MonthN <= month(input$iInvDaySal[2]), -->
<!--                 100 * MonthN + MDay >= 100 * month(input$iInvDaySal[1]) + mday(input$iInvDaySal[1]), -->
<!--                 100 * MonthN + MDay <= 100 * month(input$iInvDaySal[2]) + mday(input$iInvDaySal[2])) -->

<!-- if (input$iDataSal == "KilledTrue") dat <- dat %>% dplyr::filter(Killed) -->
<!-- if (input$iDataSal == "KilledFalse") dat <- dat %>% dplyr::filter(!Killed) -->
<!-- if (input$iDataSal == "WeightTrue") dat <- dat %>% dplyr::filter(NoWeight == 0) -->
<!-- dat <- dat %>%  -->
<!--   mutate(None = "", xV = if (iXUnitSal == "All") None else str_c(.data[[iXUnitSal]], " ", Year), grp = .data[[input$iGroupSal]]) %>%  -->
<!--   group_by_at(c("xV", "grp", input$iXUnitSal)) %>% -->
<!--   summarise(yVTotal = n(), -->
<!--             yVMaxW = max(Weight, na.rm = T),  -->
<!--             yVMaxL = max(Length, na.rm = T), -->
<!--             yVAvgW = round(mean(Weight, na.rm = T),1),  -->
<!--             yVAvgL = round(mean(Length, na.rm = T),0), -->
<!--             yVTotalW = round(sum(Weight, na.rm = T),0) -->
<!--             ) %>%  -->
<!--   arrange_at(c(input$iXUnitSal, "xV")) %>%  -->
<!--   group_by(xV) %>%  -->
<!--   mutate(pct = sum(yVTotal)) %>%  -->
<!--   group_by_at(c("xV", "grp", input$iXUnitSal)) %>%  -->
<!--   mutate(label = str_c(round(100*yVTotal/pct, 0), "%"), -->
<!--          yVPct = round(100*yVTotal/pct, 0)) %>%  -->
<!--   mutate(yV = .data[[input$iYUnitSal]])  -->

<!-- if (input$iGroupSal == "None") dat <- dat %>% mutate(label = yV) -->
<!-- xLab <- names(cIXUnit)[grep(input$iXUnitSal, cIXUnit)] -->
<!-- yLab <- names(cIYUnit)[grep(input$iYUnitSal, cIYUnit)] -->
<!-- dat$xV <- factor(dat$xV, levels = unique(dat$xV[order(dat[[input$iXUnitSal]], dat$xV)])) -->
<!-- ggplot(data = dat, aes(x = xV, y = yV)) + -->
<!--   geom_col(aes(fill = grp), position = position_dodge2(preserve = "single")) + -->
<!--   # geom_text(aes(label = yV, y = 1.05*yV), position = position_dodge2(width = 0.9)) +  -->
<!--   geom_text(aes(label = label, y = 1.05*yV), position = position_dodge2(width = 0.9), cex = 3)  +  #, vjust = "inward", hjust = "inward" -->
<!--   labs(fill = "") + xlab(xLab) + ylab(yLab) + -->
<!--   theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom") -->

<!-- ``` -->


<!-- ## Fangster per måned -->

<!-- ```{r} -->
<!-- input <- NULL -->
<!-- input$iInvYearSal <- c(2022,2022) -->
<!-- input$iInvDaySal <- c("2022-04-01", "2022-10-31") -->
<!-- input$iXUnitSal <- "Month"  # Day -->
<!-- input$iYUnitSal <- "yVTotal" -->
<!-- input$iGroupSal <- "None" -->
<!-- input$iDataSal <- "All" -->

<!-- if (input$iXUnitSal == "Day") { -->
<!--   iXUnitSal <- "DayStr" -->
<!-- } else if (input$iXUnitSal == "Year") { -->
<!--   iXUnitSal <- "None" -->
<!-- } else if (input$iXUnitSal == "None") { -->
<!--   iXUnitSal <- "All" -->
<!-- } else iXUnitSal <- input$iXUnitSal -->

<!-- dat <-  -->
<!--   datCatchSal %>%  -->
<!--   # dplyr::filter(Year >= input$iInvYearSal[1], Year <= input$iInvYearSal[2], -->
<!--   #               MDay >= min(mday(input$iInvDaySal[1]), mday(input$iInvDaySal[2])), -->
<!--   #               MDay <= max(mday(input$iInvDaySal[1]), mday(input$iInvDaySal[2])), -->
<!--   #               MonthN >= month(input$iInvDaySal[1]), -->
<!--   #               MonthN <= month(input$iInvDaySal[2]))  -->
<!--   dplyr::filter(Year >= input$iInvYearSal[1], Year <= input$iInvYearSal[2], -->
<!--                 MonthN >= month(input$iInvDaySal[1]), -->
<!--                 MonthN <= month(input$iInvDaySal[2]), -->
<!--                 100 * MonthN + MDay >= 100 * month(input$iInvDaySal[1]) + mday(input$iInvDaySal[1]), -->
<!--                 100 * MonthN + MDay <= 100 * month(input$iInvDaySal[2]) + mday(input$iInvDaySal[2])) -->

<!-- if (input$iDataSal == "KilledTrue") dat <- dat %>% dplyr::filter(Killed) -->
<!-- if (input$iDataSal == "KilledFalse") dat <- dat %>% dplyr::filter(!Killed) -->
<!-- if (input$iDataSal == "WeightTrue") dat <- dat %>% dplyr::filter(NoWeight == 0) -->
<!-- dat <- dat %>%  -->
<!--   mutate(None = "", xV = if (iXUnitSal == "All") None else str_c(.data[[iXUnitSal]], " ", Year), grp = .data[[input$iGroupSal]]) %>%  -->
<!--   group_by_at(c("xV", "grp", input$iXUnitSal)) %>% -->
<!--   summarise(yVTotal = n(), -->
<!--             yVMaxW = max(Weight, na.rm = T),  -->
<!--             yVMaxL = max(Length, na.rm = T), -->
<!--             yVAvgW = round(mean(Weight, na.rm = T),1),  -->
<!--             yVAvgL = round(mean(Length, na.rm = T),0), -->
<!--             yVTotalW = round(sum(Weight, na.rm = T),0) -->
<!--             ) %>%  -->
<!--   arrange_at(c(input$iXUnitSal, "xV")) %>%  -->
<!--   group_by(xV) %>%  -->
<!--   mutate(pct = sum(yVTotal)) %>%  -->
<!--   group_by_at(c("xV", "grp", input$iXUnitSal)) %>%  -->
<!--   mutate(label = str_c(round(100*yVTotal/pct, 0), "%"), -->
<!--          yVPct = round(100*yVTotal/pct, 0)) %>%  -->
<!--   mutate(yV = .data[[input$iYUnitSal]])  -->

<!-- if (input$iGroupSal == "None") dat <- dat %>% mutate(label = yV) -->
<!-- xLab <- names(cIXUnit)[grep(input$iXUnitSal, cIXUnit)] -->
<!-- yLab <- names(cIYUnit)[grep(input$iYUnitSal, cIYUnit)] -->
<!-- dat$xV <- factor(dat$xV, levels = unique(dat$xV[order(dat[[input$iXUnitSal]], dat$xV)])) -->
<!-- ggplot(data = dat, aes(x = xV, y = yV)) + -->
<!--   geom_col(aes(fill = grp), position = position_dodge2(preserve = "single")) + -->
<!--   # geom_text(aes(label = yV, y = 1.05*yV), position = position_dodge2(width = 0.9)) +  -->
<!--   geom_text(aes(label = label, y = 1.05*yV), position = position_dodge2(width = 0.9), cex = 3)  +  #, vjust = "inward", hjust = "inward" -->
<!--   labs(fill = "") + xlab(xLab) + ylab(yLab) + -->
<!--   theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom") -->
<!-- ``` -->




<!-- ## Fangster per måned -->

<!-- ```{r} -->
<!-- input <- NULL -->
<!-- input$iInvYearSal <- c(2022,2022) -->
<!-- input$iInvDaySal <- c("2022-04-01", "2022-10-31") -->
<!-- input$iXUnitSal <- "Month"  # Day -->
<!-- input$iYUnitSal <- "yVTotal" -->
<!-- input$iGroupSal <- "None" -->
<!-- input$iDataSal <- "All" -->

<!-- if (input$iXUnitSal == "Day") { -->
<!--   iXUnitSal <- "DayStr" -->
<!-- } else if (input$iXUnitSal == "Year") { -->
<!--   iXUnitSal <- "None" -->
<!-- } else if (input$iXUnitSal == "None") { -->
<!--   iXUnitSal <- "All" -->
<!-- } else iXUnitSal <- input$iXUnitSal -->

<!-- dat <-  -->
<!--   datCatchSal %>%  -->
<!--   # dplyr::filter(Year >= input$iInvYearSal[1], Year <= input$iInvYearSal[2], -->
<!--   #               MDay >= min(mday(input$iInvDaySal[1]), mday(input$iInvDaySal[2])), -->
<!--   #               MDay <= max(mday(input$iInvDaySal[1]), mday(input$iInvDaySal[2])), -->
<!--   #               MonthN >= month(input$iInvDaySal[1]), -->
<!--   #               MonthN <= month(input$iInvDaySal[2]))  -->
<!--   dplyr::filter(Year >= input$iInvYearSal[1], Year <= input$iInvYearSal[2], -->
<!--                 MonthN >= month(input$iInvDaySal[1]), -->
<!--                 MonthN <= month(input$iInvDaySal[2]), -->
<!--                 100 * MonthN + MDay >= 100 * month(input$iInvDaySal[1]) + mday(input$iInvDaySal[1]), -->
<!--                 100 * MonthN + MDay <= 100 * month(input$iInvDaySal[2]) + mday(input$iInvDaySal[2])) -->

<!-- if (input$iDataSal == "KilledTrue") dat <- dat %>% dplyr::filter(Killed) -->
<!-- if (input$iDataSal == "KilledFalse") dat <- dat %>% dplyr::filter(!Killed) -->
<!-- if (input$iDataSal == "WeightTrue") dat <- dat %>% dplyr::filter(NoWeight == 0) -->
<!-- dat <- dat %>%  -->
<!--   mutate(None = "", xV = if (iXUnitSal == "All") None else str_c(.data[[iXUnitSal]], " ", Year), grp = .data[[input$iGroupSal]]) %>%  -->
<!--   group_by_at(c("xV", "grp", input$iXUnitSal)) %>% -->
<!--   summarise(yVTotal = n(), -->
<!--             yVMaxW = max(Weight, na.rm = T),  -->
<!--             yVMaxL = max(Length, na.rm = T), -->
<!--             yVAvgW = round(mean(Weight, na.rm = T),1),  -->
<!--             yVAvgL = round(mean(Length, na.rm = T),0), -->
<!--             yVTotalW = round(sum(Weight, na.rm = T),0) -->
<!--             ) %>%  -->
<!--   arrange_at(c(input$iXUnitSal, "xV")) %>%  -->
<!--   group_by(xV) %>%  -->
<!--   mutate(pct = sum(yVTotal)) %>%  -->
<!--   group_by_at(c("xV", "grp", input$iXUnitSal)) %>%  -->
<!--   mutate(label = str_c(round(100*yVTotal/pct, 0), "%"), -->
<!--          yVPct = round(100*yVTotal/pct, 0)) %>%  -->
<!--   mutate(yV = .data[[input$iYUnitSal]])  -->

<!-- if (input$iGroupSal == "None") dat <- dat %>% mutate(label = yV) -->
<!-- xLab <- names(cIXUnit)[grep(input$iXUnitSal, cIXUnit)] -->
<!-- yLab <- names(cIYUnit)[grep(input$iYUnitSal, cIYUnit)] -->
<!-- dat$xV <- factor(dat$xV, levels = unique(dat$xV[order(dat[[input$iXUnitSal]], dat$xV)])) -->
<!-- ggplot(data = dat, aes(x = xV, y = yV)) + -->
<!--   geom_col(aes(fill = grp), position = position_dodge2(preserve = "single")) + -->
<!--   # geom_text(aes(label = yV, y = 1.05*yV), position = position_dodge2(width = 0.9)) +  -->
<!--   geom_text(aes(label = label, y = 1.05*yV), position = position_dodge2(width = 0.9), cex = 3)  +  #, vjust = "inward", hjust = "inward" -->
<!--   labs(fill = "") + xlab(xLab) + ylab(yLab) + -->
<!--   theme(axis.text.x  = element_text(angle=45, hjust = 1, vjust = 1), legend.position="bottom") -->
<!-- ``` -->

